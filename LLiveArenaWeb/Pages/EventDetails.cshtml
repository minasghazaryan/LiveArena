@page
@model EventDetailsModel
@using System.Text.Json
@{
    ViewData["Title"] = "Event Details";
}

@functions {
    private string Slugify(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return "team";
        var cleaned = System.Text.RegularExpressions.Regex.Replace(input.ToLowerInvariant(), @"[^a-z0-9]+", "-");
        return cleaned.Trim('-');
    }

    private string? GetTeamLogo(JsonElement? team)
    {
        if (team == null || !team.HasValue) return null;
        
        // Try different property names for logo
        if (team.Value.TryGetProperty("logo", out var logo1) && logo1.ValueKind == JsonValueKind.String)
            return logo1.GetString();
        if (team.Value.TryGetProperty("image", out var logo2) && logo2.ValueKind == JsonValueKind.String)
            return logo2.GetString();
        if (team.Value.TryGetProperty("logo_url", out var logo3) && logo3.ValueKind == JsonValueKind.String)
            return logo3.GetString();
        
        return null;
    }

    private string GetLeagueLogoPath(string? leagueName)
    {
        if (string.IsNullOrWhiteSpace(leagueName))
            return "/images/leagues/champions-league.webp";

        var name = leagueName.ToUpperInvariant();
        if (name.Contains("CHAMPIONS LEAGUE"))
            return "/images/leagues/champions-league.webp";
        if (name.Contains("EUROPA"))
            return "/images/leagues/europa-league.webp";
        if (name.Contains("CONFERENCE"))
            return "/images/leagues/conference-league.webp";
        if (name.Contains("PREMIER LEAGUE") || name.Contains("ENGLAND"))
            return "/images/leagues/English Premier League_Logo 3.webp";
        if (name.Contains("LA LIGA") || name.Contains("SPAIN"))
            return "/images/leagues/laliga-logo (1) 2.webp";

        return "/images/leagues/champions-league.webp";
    }
}

@if (Model.Event == null || !Model.Event.HasValue)
{
    <section class="hero">
        <span class="tag">Event</span>
        <h1>Event not found</h1>
        <p>@(Model.Error ?? "The selected event could not be loaded.")</p>
    </section>
}
else
{
    var evt = Model.Event.Value;
    
    // Extract home team
    var homeTeam = default(JsonElement?);
    if (evt.TryGetProperty("home_team", out var ht1)) homeTeam = ht1;
    else if (evt.TryGetProperty("homeTeam", out var ht2)) homeTeam = ht2;
    else if (evt.TryGetProperty("home", out var ht3)) homeTeam = ht3;
    
    // Extract away team
    var awayTeam = default(JsonElement?);
    if (evt.TryGetProperty("away_team", out var at1)) awayTeam = at1;
    else if (evt.TryGetProperty("awayTeam", out var at2)) awayTeam = at2;
    else if (evt.TryGetProperty("away", out var at3)) awayTeam = at3;
    
    var homeName = Model.GetStringProperty(homeTeam, "name", "short_name", "title") ?? "Home";
    var awayName = Model.GetStringProperty(awayTeam, "name", "short_name", "title") ?? "Away";
    var homeLogo = GetTeamLogo(homeTeam);
    var awayLogo = GetTeamLogo(awayTeam);
    
    // Extract scores
    var evtNullable = (JsonElement?)evt;
    var homeScore = Model.GetIntProperty(evtNullable, "home_score", "homeScore", "score_home");
    var awayScore = Model.GetIntProperty(evtNullable, "away_score", "awayScore", "score_away");

    // Handle nested score objects like { home_score: { display: 1 }, away_score: { display: 3 } }
    if (!homeScore.HasValue || !awayScore.HasValue)
    {
        if (evt.TryGetProperty("home_score", out var homeScoreObj) && homeScoreObj.ValueKind == JsonValueKind.Object)
        {
            homeScore ??= Model.GetIntProperty(homeScoreObj, "display", "current", "normal_time", "total");
        }
        if (evt.TryGetProperty("away_score", out var awayScoreObj) && awayScoreObj.ValueKind == JsonValueKind.Object)
        {
            awayScore ??= Model.GetIntProperty(awayScoreObj, "display", "current", "normal_time", "total");
        }
    }

    // Try score object fallbacks
    if (!homeScore.HasValue || !awayScore.HasValue)
    {
        var scoreObj = Model.GetObjectProperty(evtNullable, "score", "scores", "result", "final_score", "ft_score");
        if (scoreObj != null)
        {
            homeScore ??= Model.GetIntProperty(scoreObj, "home", "home_score", "homeScore", "score_home");
            awayScore ??= Model.GetIntProperty(scoreObj, "away", "away_score", "awayScore", "score_away");
        }
    }

    // Try string score fallbacks like "3-2" or "3:2"
    if (!homeScore.HasValue || !awayScore.HasValue)
    {
        var scoreText = Model.GetStringProperty(evtNullable, "score", "result", "final_score", "ft_score");
        if (!string.IsNullOrWhiteSpace(scoreText))
        {
            var parts = scoreText.Split(new[] { '-', ':' }, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2 &&
                int.TryParse(parts[0].Trim(), out var hs) &&
                int.TryParse(parts[1].Trim(), out var aw))
            {
                homeScore ??= hs;
                awayScore ??= aw;
            }
        }
    }
    
    // Extract league/competition
    var league = Model.GetObjectProperty(evtNullable, "league", "tournament", "competition", "sport");
    var leagueName = Model.GetStringProperty(league, "name", "title") ?? "League";
    var leagueLogo = league != null ? Model.GetStringProperty(league, "logo", "image", "logo_url") : null;
    
    // Extract time/date
    var startTime = Model.GetStringProperty(evtNullable, "start_at", "start_time", "start_date", "scheduled_at", "date");
    var status = Model.GetStringProperty(evtNullable, "status", "state", "stage") ?? "Live";
    var statusMore = Model.GetStringProperty(evtNullable, "status_more", "status_detail");
    var minute = Model.GetIntProperty(evtNullable, "minute", "current_minute", "time", "elapsed", "elapsed_minutes", "match_minute");
    
    // Only calculate minute if match is NOT finished
    // For finished matches, the timestamp calculation would be incorrect
    if (!Model.IsFinishedEvent && !minute.HasValue)
    {
        var timeDetails = Model.GetObjectProperty(evtNullable, "time_details", "time");
        if (timeDetails != null)
        {
            var periodStartTimestamp = Model.GetIntProperty(timeDetails, "currentPeriodStartTimestamp", "period_start_timestamp", "start_timestamp");
            if (periodStartTimestamp.HasValue)
            {
                // Calculate elapsed seconds from Unix timestamp
                var periodStart = DateTimeOffset.FromUnixTimeSeconds(periodStartTimestamp.Value).DateTime;
                var elapsedSeconds = (int)(DateTime.UtcNow - periodStart).TotalSeconds;
                var elapsedMinutes = elapsedSeconds / 60;
                
                // If status_more indicates 2nd half, add 45 minutes
                if (!string.IsNullOrEmpty(statusMore) && 
                    (statusMore.Contains("2nd", StringComparison.OrdinalIgnoreCase) || 
                     statusMore.Contains("second", StringComparison.OrdinalIgnoreCase) ||
                     statusMore.Contains("half 2", StringComparison.OrdinalIgnoreCase)))
                {
                    elapsedMinutes += 45;
                }
                
                minute = Math.Max(0, Math.Min(90, elapsedMinutes)); // Clamp between 0 and 90
            }
        }
    }
    
    // Try to get minute from nested objects (only if not finished)
    if (!Model.IsFinishedEvent && !minute.HasValue)
    {
        var timeObj = Model.GetObjectProperty(evtNullable, "time", "match_time", "current_time");
        if (timeObj != null)
        {
            minute = Model.GetIntProperty(timeObj, "minute", "current_minute", "elapsed", "value");
        }
    }
    
    // Try to get from period/periods (only if not finished)
    if (!Model.IsFinishedEvent && !minute.HasValue)
    {
        var period = Model.GetObjectProperty(evtNullable, "period", "current_period", "periods");
        if (period != null)
        {
            minute = Model.GetIntProperty(period, "minute", "elapsed", "current_minute");
        }
    }
    
    // For finished matches, clear minute value to prevent display
    if (Model.IsFinishedEvent)
    {
        minute = null;
    }
    
    // Extract odds (prefer main_odds if present)
    var odds = Model.GetArrayProperty(evtNullable, "odds", "betting", "markets");
    var mainOdds = Model.GetObjectProperty(evtNullable, "main_odds", "mainOdds");
    var isMainOdds = false;
    if (mainOdds != null)
    {
        var mainOddsList = new List<JsonElement>();
        if (mainOdds.Value.TryGetProperty("outcome_1", out var outcome1) && outcome1.ValueKind == JsonValueKind.Object)
            mainOddsList.Add(outcome1.Clone());
        if (mainOdds.Value.TryGetProperty("outcome_X", out var outcomeX) && outcomeX.ValueKind == JsonValueKind.Object)
            mainOddsList.Add(outcomeX.Clone());
        if (mainOdds.Value.TryGetProperty("outcome_2", out var outcome2) && outcome2.ValueKind == JsonValueKind.Object)
            mainOddsList.Add(outcome2.Clone());

        if (mainOddsList.Any())
        {
            odds = mainOddsList;
            isMainOdds = true;
        }
    }
    
    // Statistics are now fetched separately via API
    
    // Extract yellow cards
    var homeYellowCards = Model.GetIntProperty(homeTeam, "yellow_cards", "yellowCards", "cards_yellow", "yellow_cards_count");
    var awayYellowCards = Model.GetIntProperty(awayTeam, "yellow_cards", "yellowCards", "cards_yellow", "yellow_cards_count");
    
    // Also try to get from event level
    if (!homeYellowCards.HasValue)
    {
        var homeCards = Model.GetObjectProperty(evtNullable, "home_cards", "homeCards", "home_cards_stats");
        homeYellowCards = Model.GetIntProperty(homeCards, "yellow", "yellow_cards", "yellowCards");
    }
    if (!awayYellowCards.HasValue)
    {
        var awayCards = Model.GetObjectProperty(evtNullable, "away_cards", "awayCards", "away_cards_stats");
        awayYellowCards = Model.GetIntProperty(awayCards, "yellow", "yellow_cards", "yellowCards");
    }
    
    // Extract venue/stadium
    var venue = Model.GetObjectProperty(evtNullable, "venue", "stadium", "location");
    var venueName = Model.GetStringProperty(venue, "name", "title");
    
    DateTime? parsedTime = null;
    if (!string.IsNullOrEmpty(startTime) && DateTime.TryParse(startTime, out var dt))
        parsedTime = dt;

    DateTime? parsedTimeGmt4 = null;
    if (parsedTime.HasValue)
    {
        var value = parsedTime.Value;
        DateTime utcTime;
        if (value.Kind == DateTimeKind.Unspecified)
            utcTime = DateTime.SpecifyKind(value, DateTimeKind.Utc);
        else if (value.Kind == DateTimeKind.Local)
            utcTime = value.ToUniversalTime();
        else
            utcTime = value;

        parsedTimeGmt4 = utcTime.AddHours(4);
    }

    <section class="match-details">
        <div class="match-header">
            <div class="league-badge">
                @if (!string.IsNullOrEmpty(leagueLogo))
                {
                    <img src="@leagueLogo" alt="@leagueName logo" />
                }
                else
                {
                    <img src="@GetLeagueLogoPath(leagueName)" alt="League logo" />
                }
                <span>@leagueName</span>
            </div>
            <h1>@homeName vs @awayName</h1>
        </div>

        <div class="match-card">
            <div class="team-card">
                <div class="team-logo">
                    @if (!string.IsNullOrEmpty(homeLogo))
                    {
                        <img src="@homeLogo" alt="@homeName logo" />
                    }
                    else
                    {
                        <img src="~/images/teams/@(Slugify(homeName)).svg" alt="@homeName logo" data-fallback-initials="@homeName" />
                    }
                </div>
                <div class="team-name">@homeName</div>
                @if (homeScore.HasValue)
                {
                    <div class="team-score">@homeScore</div>
                }
            </div>

            <div class="match-time">
                @{
                    var statusText = status?.ToUpperInvariant() ?? "STATUS";
                    var isLive = Model.IsLiveEvent;
                    var isFinished = Model.IsFinishedEvent;
                }
                @if (homeScore.HasValue && awayScore.HasValue)
                {
                    <div class="match-time-clock" style="font-size: 2.5rem; font-weight: 700;">@homeScore - @awayScore</div>
                    @if (isLive && !isFinished)
                    {
                        <div class="match-time-date" style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                            <span style="display: inline-block; padding: 0.25rem 0.65rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase; background: rgba(16,185,129,0.18); border: 1px solid rgba(16,185,129,0.55); color: #10b981;">
                                LIVE
                            </span>
                            @if (minute.HasValue)
                            {
                                <span style="font-size: 1rem; font-weight: 600; color: #10b981; display: flex; align-items: center; gap: 0.4rem;">
                                    <span style="display: inline-block; width: 6px; height: 6px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                                    @minute'
                                </span>
                            }
                        </div>
                    }
                    else if (!isFinished && minute.HasValue)
                    {
                        <div class="match-time-date">@minute'</div>
                    }
                    else if (!string.IsNullOrEmpty(status))
                    {
                        <div class="match-time-date" style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                            @{
                                var badgeStyle = isFinished
                                    ? "background: rgba(148,163,184,0.18); border: 1px solid rgba(148,163,184,0.55); color: #94a3b8;"
                                    : "background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18);";
                            }
                            <span style="display: inline-block; padding: 0.25rem 0.65rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase; @badgeStyle">
                                @(isFinished ? "FT" : statusText)
                            </span>
                        </div>
                    }
                }
                else if (parsedTimeGmt4.HasValue)
                {
                    <div class="match-time-clock">@parsedTimeGmt4.Value.ToString("HH:mm")</div>
                    <div class="match-time-date">@parsedTimeGmt4.Value.ToString("dd MMMM yyyy") (GMT+4)</div>
                }
                else
                {
                    <div class="match-time-clock">@status</div>
                    @if (isLive && !isFinished && minute.HasValue)
                    {
                        <div class="match-time-date" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600; color: #10b981; margin-top: 0.5rem;">
                            <span style="display: inline-block; width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite;"></span>
                            <span>@minute'</span>
                        </div>
                    }
                    else if (!isFinished && minute.HasValue)
                    {
                        <div class="match-time-date">@minute'</div>
                    }
                }
            </div>

            <div class="team-card">
                <div class="team-logo">
                    @if (!string.IsNullOrEmpty(awayLogo))
                    {
                        <img src="@awayLogo" alt="@awayName logo" />
                    }
                    else
                    {
                        <img src="~/images/teams/@(Slugify(awayName)).svg" alt="@awayName logo" data-fallback-initials="@awayName" />
                    }
                </div>
                <div class="team-name">@awayName</div>
                @if (awayScore.HasValue)
                {
                    <div class="team-score">@awayScore</div>
                }
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(Model.HighlightEmbedUrl) || !string.IsNullOrEmpty(Model.HighlightUrl))
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Highlights</h2>
                <div class="stream-frame" style="margin-top: 1rem;">
                    @if (!string.IsNullOrEmpty(Model.HighlightEmbedUrl) && !Model.HighlightIsYouTube)
                    {
                        <div class="stream-embed">
                            <iframe
                                src="@Model.HighlightEmbedUrl"
                                frameborder="0"
                                allowfullscreen
                                allow="autoplay; encrypted-media">
                            </iframe>
                        </div>
                    }
                    else
                    {
                        <div style="padding: 1.5rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
                            @if (!string.IsNullOrEmpty(Model.HighlightThumbnailUrl))
                            {
                                <a href="@Model.HighlightUrl" target="_blank" rel="noopener noreferrer" style="display: block; position: relative; width: 100%;">
                                    <img src="@Model.HighlightThumbnailUrl" alt="Highlight thumbnail" style="width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem; display: block;" />
                                    <span style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;">
                                        <span style="width: 64px; height: 64px; border-radius: 50%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.35);">
                                            <span style="width: 0; height: 0; border-top: 12px solid transparent; border-bottom: 12px solid transparent; border-left: 18px solid #ffffff; margin-left: 4px;"></span>
                                        </span>
                                    </span>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        }
        else if (!string.IsNullOrEmpty(Model.StreamUrl) && !string.IsNullOrWhiteSpace(Model.StreamUrl) && !Model.IsFinishedEvent)
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Live Stream</h2>
                <div class="stream-frame" style="margin-top: 1rem;">
                    <div class="stream-embed">
                        <iframe
                            id="streamFrame"
                            src="@Model.StreamUrl"
                            frameborder="0"
                            allowfullscreen
                            allow="autoplay; encrypted-media"
                            style="width: 100%; min-height: 400px; background: #000;"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        </iframe>
                        <div style="display: none; padding: 2rem; text-align: center; color: var(--muted);">
                            <p>Stream failed to load. Please try refreshing the page.</p>
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (Model.IsLiveEvent && !Model.IsFinishedEvent)
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Live Stream</h2>
                <div style="margin-top: 1rem; padding: 2rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
                    @if (Model.StreamResponse != null && !string.IsNullOrEmpty(Model.StreamResponse.Message))
                    {
                        <p style="color: var(--muted); margin-bottom: 0.5rem;">@Model.StreamResponse.Message</p>
                    }
                    else
                    {
                        <p style="color: var(--muted); margin-bottom: 0.5rem;">Live stream is not available for this event at the moment.</p>
                    }
                    @if (Model.StreamResponse != null && !Model.StreamResponse.Success)
                    {
                        <p style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem;">Stream could not be loaded. The match may not have an available stream source.</p>
                    }
                </div>
            </div>
        }
        else if (!Model.IsFinishedEvent && Model.StreamResponse != null && !Model.StreamResponse.Success)
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Live Stream</h2>
                <div style="margin-top: 1rem; padding: 2rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
                    @if (!string.IsNullOrEmpty(Model.StreamResponse.Message))
                    {
                        <p style="color: var(--muted); margin-bottom: 0.5rem;">@Model.StreamResponse.Message</p>
                    }
                    else
                    {
                        <p style="color: var(--muted); margin-bottom: 0.5rem;">Stream information could not be retrieved for this event.</p>
                    }
                    <p style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem;">Unable to find stream source. This may be because the event ID does not match any available streams in the MatchListService database.</p>
                </div>
            </div>
        }
        else if (!Model.IsFinishedEvent && !Model.IsLiveEvent)
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Live Stream</h2>
                <div style="margin-top: 1rem; padding: 2rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); text-align: center;">
                    <p style="color: var(--muted);">Live stream is not available yet.</p>
                    <p style="color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem;">The stream will be available once the match starts.</p>
                </div>
            </div>
        }

        @if (homeYellowCards.HasValue || awayYellowCards.HasValue)
        {
            <div class="match-info">
                <h2>Yellow Cards</h2>
                <div style="display: flex; justify-content: space-around; align-items: center; gap: 2rem; margin-top: 1rem; padding: 1.5rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem;">@homeName</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #ffd700; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span style="font-size: 2rem;">ðŸŸ¨</span>
                            <span>@(homeYellowCards ?? 0)</span>
                        </div>
                    </div>
                    <div style="font-size: 1.5rem; color: var(--muted);">vs</div>
                    <div style="text-align: center; flex: 1;">
                        <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem;">@awayName</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: #ffd700; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span style="font-size: 2rem;">ðŸŸ¨</span>
                            <span>@(awayYellowCards ?? 0)</span>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (odds.Any())
        {
            <div class="match-info" style="padding: 0.75rem;">
                <h2 style="margin-bottom: 0.5rem; font-size: 0.95rem;">Odds</h2>
                <div class="odds-grid" style="gap: 0.5rem;">
                    @{
                        var oddIndex = 0;
                        var mainOddsLabels = new[] { "1", "X", "2" };
                    }
                    @foreach (var odd in odds)
                    {
                        var oddName = isMainOdds && oddIndex < mainOddsLabels.Length
                            ? mainOddsLabels[oddIndex]
                            : (Model.GetStringProperty(odd, "name", "title", "market", "label") ?? "Odds");
                        var oddValue = Model.GetStringProperty(odd, "value", "odds", "price", "decimal", "fractional");
                        if (isMainOdds && string.IsNullOrEmpty(oddValue))
                        {
                            if (odd.TryGetProperty("value", out var mainValue) && mainValue.ValueKind == JsonValueKind.Number)
                            {
                                oddValue = mainValue.GetDouble().ToString("0.##");
                            }
                        }
                        var oddType = Model.GetStringProperty(odd, "type", "market_type", "category");
                        var oddBookmaker = Model.GetStringProperty(odd, "bookmaker", "bookie", "provider");
                        oddIndex++;
                        
                        <div class="odds-card" style="padding: 0.4rem 0.6rem;">
                            <div class="odds-title" style="font-size: 0.65rem; margin-bottom: 0.2rem;">@oddName</div>
                            @if (!string.IsNullOrEmpty(oddValue))
                            {
                                <div class="odds-value" style="font-size: 0.95rem;">@oddValue</div>
                            }
                            @if (!string.IsNullOrEmpty(oddType))
                            {
                                <div class="odds-type" style="font-size: 0.7rem; margin-top: 0.2rem;">@oddType</div>
                            }
                            @if (!string.IsNullOrEmpty(oddBookmaker))
                            {
                                <div class="odds-bookmaker" style="font-size: 0.65rem; margin-top: 0.2rem;">@oddBookmaker</div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model.Statistics.Any())
        {
            // Get all statistics and create lookup by name
            var allStats = Model.Statistics.ToList();
                var statsDict = new Dictionary<string, JsonElement>();
                foreach (var stat in allStats)
                {
                    var name = Model.GetStringProperty(stat, "name") ?? "";
                    if (!string.IsNullOrEmpty(name) && !statsDict.ContainsKey(name))
                        statsDict[name] = stat;
                }
                
                // Helper function to parse percentage or number
                Func<string, double> parseValue = (val) => {
                    if (string.IsNullOrEmpty(val)) return 0;
                    val = val.TrimEnd('%');
                    if (double.TryParse(val, out var num)) return num;
                    return 0;
                };
                
                // Define statistics to show with display names
                var statList = new List<(string Key, string Display, JsonElement? Stat, string? HomeValue, string? AwayValue, int? CompareCode)>();
                
                // Ball Possession
                if (statsDict.ContainsKey("ball_possession"))
                {
                    var stat = statsDict["ball_possession"];
                    statList.Add(("ball_possession", "Ball Possession", stat, 
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                
                // Passes
                if (statsDict.ContainsKey("passes"))
                {
                    var stat = statsDict["passes"];
                    statList.Add(("passes", "Passes", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                
                // Pass Accuracy (calculated from accurate_passes and passes)
                if (statsDict.ContainsKey("passes") && statsDict.ContainsKey("accurate_passes"))
                {
                    var passesStat = statsDict["passes"];
                    var accurateStat = statsDict["accurate_passes"];
                    var homePasses = parseValue(Model.GetStringProperty(accurateStat, "home") ?? "0");
                    var awayPasses = parseValue(Model.GetStringProperty(accurateStat, "away") ?? "0");
                    var homeTotal = parseValue(Model.GetStringProperty(passesStat, "home") ?? "0");
                    var awayTotal = parseValue(Model.GetStringProperty(passesStat, "away") ?? "0");
                    var homeAcc = homeTotal > 0 ? (int)((homePasses / homeTotal) * 100) : 0;
                    var awayAcc = awayTotal > 0 ? (int)((awayPasses / awayTotal) * 100) : 0;
                    var compareCode = homeAcc > awayAcc ? 1 : (awayAcc > homeAcc ? 2 : 3);
                    statList.Add(("pass_accuracy", "Pass Accuracy", null, $"{homeAcc}%", $"{awayAcc}%", compareCode));
                }
                
                // Fouls
                if (statsDict.ContainsKey("fouls"))
                {
                    var stat = statsDict["fouls"];
                    statList.Add(("fouls", "Fouls", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                
                // Yellow Cards
                if (statsDict.ContainsKey("yellow_cards"))
                {
                    var stat = statsDict["yellow_cards"];
                    statList.Add(("yellow_cards", "Yellow Cards", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                
                // Red Cards (may not exist, show 0|0)
                if (statsDict.ContainsKey("red_cards"))
                {
                    var stat = statsDict["red_cards"];
                    statList.Add(("red_cards", "Red Cards", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else
                {
                    statList.Add(("red_cards", "Red Cards", null, "0", "0", 3));
                }
                
                // Total Shots (from shots group or match_overview)
                if (statsDict.ContainsKey("total_shots"))
                {
                    var stat = statsDict["total_shots"];
                    statList.Add(("total_shots", "Total Shots", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else
                {
                    statList.Add(("total_shots", "Total Shots", null, "0", "0", 3));
                }
                
                // Shots On Target (from shots group)
                if (statsDict.ContainsKey("shots_on_target"))
                {
                    var stat = statsDict["shots_on_target"];
                    statList.Add(("shots_on_target", "Shots On Target", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else
                {
                    statList.Add(("shots_on_target", "Shots On Target", null, "0", "0", 3));
                }
                
                // Blocked Shots (from shots group)
                if (statsDict.ContainsKey("blocked_shots"))
                {
                    var stat = statsDict["blocked_shots"];
                    statList.Add(("blocked_shots", "Blocked Shots", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else
                {
                    statList.Add(("blocked_shots", "Blocked Shots", null, "0", "0", 3));
                }
                
                // Saves
                if (statsDict.ContainsKey("goalkeeper_saves"))
                {
                    var stat = statsDict["goalkeeper_saves"];
                    statList.Add(("goalkeeper_saves", "Saves", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else if (statsDict.ContainsKey("total_saves"))
                {
                    var stat = statsDict["total_saves"];
                    statList.Add(("goalkeeper_saves", "Saves", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                
                // Corner Kicks
                if (statsDict.ContainsKey("corner_kicks"))
                {
                    var stat = statsDict["corner_kicks"];
                    statList.Add(("corner_kicks", "Corner Kicks", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else
                {
                    statList.Add(("corner_kicks", "Corner Kicks", null, "0", "0", 3));
                }
                
                // Offsides (may not exist, show 0|0)
                if (statsDict.ContainsKey("offsides"))
                {
                    var stat = statsDict["offsides"];
                    statList.Add(("offsides", "Offsides", stat,
                        Model.GetStringProperty(stat, "home"), Model.GetStringProperty(stat, "away"),
                        Model.GetIntProperty(stat, "compare_code")));
                }
                else
                {
                    statList.Add(("offsides", "Offsides", null, "0", "0", 3));
                }
            
            <div class="match-info" style="margin-top: 2rem;">
                <h2 style="text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">Statistics</h2>
                
                <!-- Team Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 0 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        @if (!string.IsNullOrEmpty(homeLogo))
                        {
                            <img src="@homeLogo" alt="@homeName logo" style="width: 40px; height: 40px; object-fit: contain;" />
                        }
                        <span style="font-weight: 600; font-size: 1rem;">@homeName</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        @if (!string.IsNullOrEmpty(awayLogo))
                        {
                            <img src="@awayLogo" alt="@awayName logo" style="width: 40px; height: 40px; object-fit: contain;" />
                        }
                        <span style="font-weight: 600; font-size: 1rem;">@awayName</span>
                    </div>
                </div>
                
                <!-- Statistics Grid - Two Columns -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                    @for (int col = 0; col < 2; col++)
                    {
                        <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                            @for (int i = col; i < statList.Count; i += 2)
                            {
                                var statItem = statList[i];
                                var homeValue = statItem.HomeValue ?? "0";
                                var awayValue = statItem.AwayValue ?? "0";
                                var compareCode = statItem.CompareCode ?? 3;
                                
                                // Parse values for bar calculation
                                Func<string, double> parseVal = (val) => {
                                    if (string.IsNullOrEmpty(val)) return 0;
                                    val = val.TrimEnd('%');
                                    if (double.TryParse(val, out var num)) return num;
                                    return 0;
                                };
                                var homeNum = parseVal(homeValue);
                                var awayNum = parseVal(awayValue);
                                var total = homeNum + awayNum;
                                
                                // Calculate percentages for bar
                                double homePercent = 0, awayPercent = 0;
                                if (total > 0)
                                {
                                    homePercent = (homeNum / total) * 100;
                                    awayPercent = (awayNum / total) * 100;
                                }
                                else
                                {
                                    homePercent = 50;
                                    awayPercent = 50;
                                }
                                
                                // Determine bar colors (white for leading, grey for trailing/equal)
                                var homeBarColor = compareCode == 1 ? "#ffffff" : "rgba(255,255,255,0.3)";
                                var awayBarColor = compareCode == 2 ? "#ffffff" : "rgba(255,255,255,0.3)";
                                if (compareCode == 3 || (homeNum == 0 && awayNum == 0))
                                {
                                    homeBarColor = "rgba(255,255,255,0.3)";
                                    awayBarColor = "rgba(255,255,255,0.3)";
                                }
                                
                                // Value styles
                                var homeValueStyle = compareCode == 1 ? "color: #ffffff; font-weight: 700;" : "color: rgba(255,255,255,0.7); font-weight: 600;";
                                var awayValueStyle = compareCode == 2 ? "color: #ffffff; font-weight: 700;" : "color: rgba(255,255,255,0.7); font-weight: 600;";
                                
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <!-- Stat Row: Home Value | Label | Away Value -->
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="@homeValueStyle; font-size: 1rem;">@homeValue</span>
                                        <span style="color: rgba(255,255,255,0.5); font-size: 0.85rem; font-weight: 500; text-align: center; flex: 1; padding: 0 0.5rem;">@statItem.Display</span>
                                        <span style="@awayValueStyle; font-size: 1rem;">@awayValue</span>
                                    </div>
                                    
                                    <!-- Comparison Bar -->
                                    <div style="display: flex; height: 4px; border-radius: 2px; overflow: hidden; background: rgba(255,255,255,0.1);">
                                        <div style="width: @homePercent%; background: @homeBarColor; transition: all 0.3s ease;"></div>
                                        <div style="width: @awayPercent%; background: @awayBarColor; transition: all 0.3s ease;"></div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model.Lineups.Any())
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2 style="text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">Lineups</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem;">
                    @foreach (var lineup in Model.Lineups)
                    {
                        var team = Model.GetObjectProperty(lineup, "team");
                        var teamName = Model.GetStringProperty(team, "name", "name_short") ?? "Team";
                        var teamLogo = Model.GetStringProperty(team, "logo");
                        var formation = Model.GetStringProperty(lineup, "formation") ?? "";
                        var lineupPlayers = Model.GetArrayProperty(lineup, "lineup_players");
                        var missingPlayers = Model.GetArrayProperty(lineup, "missing_players");
                        
                        // Determine if this is home or away team
                        var isHomeTeam = homeName.Equals(teamName, StringComparison.OrdinalIgnoreCase) ||
                                       (!string.IsNullOrEmpty(teamName) && homeName.Contains(teamName, StringComparison.OrdinalIgnoreCase)) ||
                                       (!string.IsNullOrEmpty(teamName) && teamName.Contains(homeName, StringComparison.OrdinalIgnoreCase));
                        
                        <div style="background: var(--surface-strong); border-radius: 12px; border: 1px solid var(--border); padding: 1.5rem;">
                            <!-- Team Header -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    @if (!string.IsNullOrEmpty(teamLogo))
                                    {
                                        <img src="@teamLogo" alt="@teamName logo" style="width: 40px; height: 40px; object-fit: contain;" />
                                    }
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.1rem;">@teamName</div>
                                        @if (!string.IsNullOrEmpty(formation))
                                        {
                                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem;">Formation: @formation</div>
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Starting Lineup -->
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">Starting XI</h3>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    @foreach (var player in lineupPlayers.Where(p => {
                                        var substitute = Model.GetIntProperty(p, "substitute") ?? 0;
                                        return substitute == 0;
                                    }).OrderBy(p => Model.GetIntProperty(p, "position") ?? 999))
                                    {
                                        var playerObj = Model.GetObjectProperty(player, "player");
                                        var playerName = Model.GetStringProperty(playerObj, "name", "name_short") ?? "Player";
                                        var shirtNumber = Model.GetIntProperty(player, "shirt_number") ?? 0;
                                        var position = Model.GetStringProperty(player, "position_name", "position_key") ?? "";
                                        var isCaptain = Model.GetIntProperty(player, "is_captain") == 1;
                                        var playerPhoto = Model.GetStringProperty(playerObj, "photo");
                                        
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--surface); border-radius: 6px; border: 1px solid var(--border);">
                                            @if (!string.IsNullOrEmpty(playerPhoto))
                                            {
                                                <img src="@playerPhoto" alt="@playerName" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" />
                                            }
                                            else
                                            {
                                                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--surface-strong); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: var(--muted); flex-shrink: 0;">
                                                    @(playerName.Length > 0 ? playerName.Substring(0, Math.Min(2, playerName.Length)).ToUpper() : "P")
                                                </div>
                                            }
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    @if (shirtNumber > 0)
                                                    {
                                                        <span style="font-weight: 700; color: var(--accent); font-size: 0.9rem; min-width: 24px;">@shirtNumber</span>
                                                    }
                                                    <span style="font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@playerName</span>
                                                    @if (isCaptain)
                                                    {
                                                        <span style="font-size: 0.75rem; color: var(--accent);">Â©</span>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(position))
                                                {
                                                    <div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.15rem;">@position</div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <!-- Missing Players -->
                            @if (missingPlayers.Any())
                            {
                                <div>
                                    <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem;">Missing Players</h3>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        @foreach (var missingPlayer in missingPlayers)
                                        {
                                            var playerObj = Model.GetObjectProperty(missingPlayer, "player");
                                            var playerName = Model.GetStringProperty(playerObj, "name", "name_short") ?? "Player";
                                            var reason = Model.GetIntProperty(missingPlayer, "reason");
                                            var type = Model.GetStringProperty(missingPlayer, "type") ?? "";
                                            var reasonText = type.Equals("doubtful", StringComparison.OrdinalIgnoreCase) ? "Doubtful" : "Missing";
                                            var playerPhoto = Model.GetStringProperty(playerObj, "photo");
                                            
                                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.4rem; background: rgba(148,163,184,0.1); border-radius: 6px; border: 1px solid rgba(148,163,184,0.2);">
                                                @if (!string.IsNullOrEmpty(playerPhoto))
                                                {
                                                    <img src="@playerPhoto" alt="@playerName" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; flex-shrink: 0; opacity: 0.6;" />
                                                }
                                                else
                                                {
                                                    <div style="width: 28px; height: 28px; border-radius: 50%; background: var(--surface-strong); display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600; color: var(--muted); flex-shrink: 0; opacity: 0.6;">
                                                        @(playerName.Length > 0 ? playerName.Substring(0, Math.Min(2, playerName.Length)).ToUpper() : "P")
                                                    </div>
                                                }
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <span style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.7;">@playerName</span>
                                                        <span style="font-size: 0.7rem; color: var(--muted); padding: 0.15rem 0.4rem; background: rgba(148,163,184,0.2); border-radius: 4px;">@reasonText</span>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model.Incidents.Any())
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2 style="text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;">Match Events</h2>
                
                <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 800px; margin: 0 auto;">
                    @foreach (var incident in Model.Incidents)
                    {
                        var incidentType = Model.GetStringProperty(incident, "incident_type") ?? "";
                        var time = Model.GetIntProperty(incident, "time") ?? 0;
                        var timeOver = Model.GetIntProperty(incident, "time_over");
                        var player = Model.GetObjectProperty(incident, "player");
                        var playerName = Model.GetStringProperty(player, "name_short", "name") ?? "";
                        var playerPhoto = Model.GetStringProperty(player, "photo");
                        var playerTeam = Model.GetIntProperty(incident, "player_team");
                        var scoringTeam = Model.GetIntProperty(incident, "scoring_team");
                        var cardType = Model.GetStringProperty(incident, "card_type");
                        var reason = Model.GetStringProperty(incident, "reason");
                        var text = Model.GetStringProperty(incident, "text");
                        var incidentHomeScore = Model.GetIntProperty(incident, "home_score");
                        var incidentAwayScore = Model.GetIntProperty(incident, "away_score");
                        var playerTwoIn = Model.GetObjectProperty(incident, "player_two_in");
                        var playerTwoInName = Model.GetStringProperty(playerTwoIn, "name_short", "name") ?? "";
                        var playerTwoInPhoto = Model.GetStringProperty(playerTwoIn, "photo");
                        
                        // Determine if this is a home team event
                        var isHomeEvent = (playerTeam == 1 || scoringTeam == 1);
                        
                        // Format time display
                        var timeDisplay = time.ToString();
                        if (timeOver.HasValue && timeOver.Value > 0 && timeOver.Value < 999)
                        {
                            timeDisplay = $"{time}+{timeOver}";
                        }
                        else if (timeOver.HasValue && timeOver.Value == 999)
                        {
                            timeDisplay = time.ToString();
                        }
                        
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                            <!-- Time -->
                            <div style="min-width: 50px; text-align: center; font-weight: 700; font-size: 0.9rem; color: var(--accent);">
                                @timeDisplay'
                            </div>
                            
                            <!-- Event Icon/Content -->
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.75rem;">
                                @if (incidentType.Equals("goal", StringComparison.OrdinalIgnoreCase))
                                {
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;">âš½</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.95rem;">
                                            @if (!string.IsNullOrEmpty(playerName))
                                            {
                                                <span>Goal: @playerName</span>
                                            }
                                            else
                                            {
                                                <span>Goal</span>
                                            }
                                        </div>
                                        @if (incidentHomeScore.HasValue && incidentAwayScore.HasValue)
                                        {
                                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem;">
                                                @incidentHomeScore - @incidentAwayScore
                                            </div>
                                        }
                                    </div>
                                }
                                else if (incidentType.Equals("card", StringComparison.OrdinalIgnoreCase))
                                {
                                    var cardColor = cardType?.Equals("Red", StringComparison.OrdinalIgnoreCase) == true ? "#ef4444" : "#fbbf24";
                                    <div style="width: 32px; height: 32px; border-radius: 4px; background: @cardColor; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; color: white; font-weight: 700;">
                                        @(cardType?.Substring(0, 1) ?? "C")
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.95rem;">
                                            @if (!string.IsNullOrEmpty(playerName))
                                            {
                                                <span>@cardType Card: @playerName</span>
                                            }
                                            else
                                            {
                                                <span>@cardType Card</span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(reason))
                                        {
                                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem;">@reason</div>
                                        }
                                    </div>
                                }
                                else if (incidentType.Equals("substitution", StringComparison.OrdinalIgnoreCase))
                                {
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(59,130,246,0.2); border: 2px solid #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; color: #3b82f6; font-weight: 700;">â‡„</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.95rem;">
                                            @if (!string.IsNullOrEmpty(playerName) && !string.IsNullOrEmpty(playerTwoInName))
                                            {
                                                <span>@playerName â†” @playerTwoInName</span>
                                            }
                                            else if (!string.IsNullOrEmpty(playerName))
                                            {
                                                <span>Substitution: @playerName</span>
                                            }
                                            else
                                            {
                                                <span>Substitution</span>
                                            }
                                        </div>
                                    </div>
                                }
                                else if (incidentType.Equals("period", StringComparison.OrdinalIgnoreCase))
                                {
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; color: var(--muted); font-weight: 700;">â±</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.95rem;">
                                            @if (!string.IsNullOrEmpty(text))
                                            {
                                                <span>@text</span>
                                            }
                                            else
                                            {
                                                <span>Period</span>
                                            }
                                        </div>
                                        @if (incidentHomeScore.HasValue && incidentAwayScore.HasValue)
                                        {
                                            <div style="font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem;">
                                                @incidentHomeScore - @incidentAwayScore
                                            </div>
                                        }
                                    </div>
                                }
                                else if (incidentType.Equals("injuryTime", StringComparison.OrdinalIgnoreCase))
                                {
                                    var length = Model.GetIntProperty(incident, "length");
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; color: var(--muted); font-weight: 700;">+</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.95rem;">
                                            @if (length.HasValue)
                                            {
                                                <span>Injury Time: +@length min</span>
                                            }
                                            else
                                            {
                                                <span>Injury Time</span>
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; color: var(--muted);">â€¢</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 0.95rem;">
                                            @if (!string.IsNullOrEmpty(text))
                                            {
                                                <span>@text</span>
                                            }
                                            else
                                            {
                                                <span>@incidentType</span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Player Photo (if available) -->
                            @if (!string.IsNullOrEmpty(playerPhoto) && !incidentType.Equals("period", StringComparison.OrdinalIgnoreCase) && !incidentType.Equals("injuryTime", StringComparison.OrdinalIgnoreCase))
                            {
                                <img src="@playerPhoto" alt="@playerName" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" />
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model.Venue.HasValue)
        {
            var venueData = Model.Venue.Value;
            var venueNameFromApi = Model.GetStringProperty(venueData, "name", "title");
            var venueCity = Model.GetStringProperty(venueData, "city");
            var venueCountry = Model.GetStringProperty(venueData, "country");
            var venueCapacity = Model.GetIntProperty(venueData, "capacity");
            var venueAddress = Model.GetStringProperty(venueData, "address");
            
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Venue</h2>
                <div style="padding: 1.5rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); margin-top: 1rem;">
                    @if (!string.IsNullOrEmpty(venueNameFromApi))
                    {
                        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem;">@venueNameFromApi</div>
                    }
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; color: var(--muted);">
                        @if (!string.IsNullOrEmpty(venueCity))
                        {
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>ðŸ“</span>
                                <span>@venueCity@(!string.IsNullOrEmpty(venueCountry) ? $", {venueCountry}" : "")</span>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(venueAddress))
                        {
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>ðŸ›ï¸</span>
                                <span>@venueAddress</span>
                            </div>
                        }
                        @if (venueCapacity.HasValue)
                        {
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>ðŸ‘¥</span>
                                <span>Capacity: @venueCapacity.Value.ToString("N0")</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (!string.IsNullOrEmpty(venueName))
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Venue</h2>
                <div style="padding: 1.5rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); margin-top: 1rem;">
                    <div style="font-size: 1.1rem; font-weight: 700;">@venueName</div>
                </div>
            </div>
        }

        @if (Model.Referee.HasValue)
        {
            var referee = Model.Referee.Value;
            var refereeName = Model.GetStringProperty(referee, "name", "name_full", "title");
            var refereeCountry = Model.GetStringProperty(referee, "country");
            var refereePhoto = Model.GetStringProperty(referee, "photo", "image");
            
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Referee</h2>
                <div style="padding: 1.5rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        @if (!string.IsNullOrEmpty(refereePhoto))
                        {
                            <img src="@refereePhoto" alt="@refereeName" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;" />
                        }
                        <div>
                            @if (!string.IsNullOrEmpty(refereeName))
                            {
                                <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">@refereeName</div>
                            }
                            @if (!string.IsNullOrEmpty(refereeCountry))
                            {
                                <div style="font-size: 0.9rem; color: var(--muted);">@refereeCountry</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (Model.Markets.Any())
        {
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Betting Markets</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
                    @foreach (var market in Model.Markets)
                    {
                        var marketName = Model.GetStringProperty(market, "name", "title", "market_name");
                        var marketId = Model.GetIntProperty(market, "id", "market_id");
                        var handicap = Model.GetStringProperty(market, "handicap");
                        var marketIsLive = Model.GetIntProperty(market, "is_live") == 1 || 
                                           (Model.GetStringProperty(market, "is_live")?.ToLowerInvariant() == "true");
                        var outcomes = Model.GetArrayProperty(market, "outcomes", "outcome");
                        
                        // Build display name: add handicap if present and not null
                        var displayName = marketName ?? "";
                        if (!string.IsNullOrEmpty(handicap) && handicap.ToLowerInvariant() != "null")
                        {
                            // For markets with handicap, show it in the name (e.g., "Match goals (0.5)")
                            displayName = $"{marketName} ({handicap})";
                        }
                        
                        // Determine odds color based on is_live status
                        var oddsColor = marketIsLive ? "#10b981" : "var(--muted)"; // Green for live, muted for non-live
                        
                        <div style="padding: 0.75rem; background: var(--surface-strong); border-radius: 6px; border: 1px solid var(--border);">
                            @if (!string.IsNullOrEmpty(displayName))
                            {
                                <div style="font-size: 0.8rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">@displayName</div>
                            }
                            @if (outcomes.Any())
                            {
                                <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                                    @foreach (var outcome in outcomes)
                                    {
                                        var outcomeName = Model.GetStringProperty(outcome, "name", "title", "label", "outcome_name");
                                        var outcomeValue = "";
                                        
                                        // Get items array from outcome
                                        var items = Model.GetArrayProperty(outcome, "items");
                                        if (items.Any())
                                        {
                                            // Find the item with the latest created_value_at
                                            JsonElement? latestItem = null;
                                            DateTime? latestDate = null;
                                            
                                            foreach (var item in items)
                                            {
                                                var createdAtStr = Model.GetStringProperty(item, "created_value_at", "created_at", "timestamp");
                                                if (!string.IsNullOrEmpty(createdAtStr) && DateTime.TryParse(createdAtStr, out var createdAt))
                                                {
                                                    if (!latestDate.HasValue || createdAt > latestDate.Value)
                                                    {
                                                        latestDate = createdAt;
                                                        latestItem = item;
                                                    }
                                                }
                                            }
                                            
                                            // If we found the latest item, get its value
                                            if (latestItem.HasValue)
                                            {
                                                var itemValue = Model.GetStringProperty(latestItem, "value");
                                                if (string.IsNullOrEmpty(itemValue))
                                                {
                                                    if (latestItem.Value.TryGetProperty("value", out var val) && val.ValueKind == JsonValueKind.Number)
                                                    {
                                                        outcomeValue = val.GetDouble().ToString("0.##");
                                                    }
                                                }
                                                else
                                                {
                                                    outcomeValue = itemValue;
                                                }
                                            }
                                        }
                                        
                                        // Fallback to avg_value if no items found
                                        if (string.IsNullOrEmpty(outcomeValue))
                                        {
                                            var avgValue = Model.GetStringProperty(outcome, "avg_value");
                                            if (string.IsNullOrEmpty(avgValue))
                                            {
                                                if (outcome.TryGetProperty("avg_value", out var avgVal) && avgVal.ValueKind == JsonValueKind.Number)
                                                {
                                                    outcomeValue = avgVal.GetDouble().ToString("0.##");
                                                }
                                                else if (outcome.TryGetProperty("value", out var val) && val.ValueKind == JsonValueKind.Number)
                                                {
                                                    outcomeValue = val.GetDouble().ToString("0.##");
                                                }
                                            }
                                            else
                                            {
                                                outcomeValue = avgValue;
                                            }
                                        }
                                        
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0.5rem; background: var(--surface); border-radius: 3px;">
                                            <span style="font-size: 0.8rem;">@(outcomeName ?? "Outcome")</span>
                                            @if (!string.IsNullOrEmpty(outcomeValue))
                                            {
                                                <span style="font-weight: 700; color: @oddsColor;">@outcomeValue</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model.H2H.HasValue)
        {
            var h2h = Model.H2H.Value;
            var recentMatches = Model.GetArrayProperty(h2h, "recent_matches", "matches", "history");
            var homeStats = Model.GetObjectProperty(h2h, "home_stats", "home_team_stats");
            var awayStats = Model.GetObjectProperty(h2h, "away_stats", "away_team_stats");
            var headToHeadMatches = Model.GetArrayProperty(h2h, "head_to_head", "h2h_matches");
            
            <div class="match-info" style="margin-top: 2rem;">
                <h2>Head-to-Head</h2>
                
                @if (headToHeadMatches.Any())
                {
                    <div style="margin-top: 1rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Previous Meetings</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            @foreach (var match in headToHeadMatches.Take(5))
                            {
                                var matchDate = Model.GetStringProperty(match, "date", "start_at", "start_time");
                                var matchHomeTeam = Model.GetObjectProperty(match, "home_team", "homeTeam");
                                var matchAwayTeam = Model.GetObjectProperty(match, "away_team", "awayTeam");
                                var matchHomeScore = Model.GetIntProperty(match, "home_score", "homeScore");
                                var matchAwayScore = Model.GetIntProperty(match, "away_score", "awayScore");
                                var matchHomeName = Model.GetStringProperty(matchHomeTeam, "name", "name_short") ?? "Home";
                                var matchAwayName = Model.GetStringProperty(matchAwayTeam, "name", "name_short") ?? "Away";
                                
                                <div style="padding: 1rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="flex: 1; text-align: right;">
                                            <span style="font-weight: 600;">@matchHomeName</span>
                                        </div>
                                        <div style="padding: 0 1rem; font-weight: 700; font-size: 1.1rem;">
                                            @if (matchHomeScore.HasValue && matchAwayScore.HasValue)
                                            {
                                                <span>@matchHomeScore - @matchAwayScore</span>
                                            }
                                            else
                                            {
                                                <span style="color: var(--muted);">vs</span>
                                            }
                                        </div>
                                        <div style="flex: 1; text-align: left;">
                                            <span style="font-weight: 600;">@matchAwayName</span>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(matchDate))
                                    {
                                        <div style="text-align: center; font-size: 0.75rem; color: var(--muted);">@matchDate</div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                
                @if (homeStats != null && awayStats != null)
                {
                    <div style="margin-top: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">Recent Form</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="padding: 1rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.5rem;">@homeName</div>
                                @{
                                    var homeWins = Model.GetIntProperty(homeStats, "wins", "wins_total") ?? 0;
                                    var homeDraws = Model.GetIntProperty(homeStats, "draws", "draws_total") ?? 0;
                                    var homeLosses = Model.GetIntProperty(homeStats, "losses", "losses_total") ?? 0;
                                }
                                <div style="display: flex; gap: 0.5rem; font-size: 0.9rem;">
                                    <span style="color: #10b981;">W: @homeWins</span>
                                    <span style="color: var(--muted);">D: @homeDraws</span>
                                    <span style="color: #ef4444;">L: @homeLosses</span>
                                </div>
                            </div>
                            <div style="padding: 1rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 0.5rem;">@awayName</div>
                                @{
                                    var awayWins = Model.GetIntProperty(awayStats, "wins", "wins_total") ?? 0;
                                    var awayDraws = Model.GetIntProperty(awayStats, "draws", "draws_total") ?? 0;
                                    var awayLosses = Model.GetIntProperty(awayStats, "losses", "losses_total") ?? 0;
                                }
                                <div style="display: flex; gap: 0.5rem; font-size: 0.9rem;">
                                    <span style="color: #10b981;">W: @awayWins</span>
                                    <span style="color: var(--muted);">D: @awayDraws</span>
                                    <span style="color: #ef4444;">L: @awayLosses</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        @if (Model.Trends.HasValue)
        {
            var trends = Model.Trends.Value;
            var trendData = Model.GetArrayProperty(trends, "trends", "data", "items");
            
            @if (trendData.Any())
            {
                <div class="match-info" style="margin-top: 2rem;">
                    <h2>Trends</h2>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                        @foreach (var trend in trendData)
                        {
                            var trendType = Model.GetStringProperty(trend, "type", "trend_type", "name");
                            var trendDescription = Model.GetStringProperty(trend, "description", "text", "title");
                            var trendValue = Model.GetStringProperty(trend, "value");
                            
                            <div style="padding: 1rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                                @if (!string.IsNullOrEmpty(trendType))
                                {
                                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">@trendType</div>
                                }
                                @if (!string.IsNullOrEmpty(trendDescription))
                                {
                                    <div style="font-size: 0.95rem;">@trendDescription</div>
                                }
                                @if (!string.IsNullOrEmpty(trendValue))
                                {
                                    <div style="font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem;">@trendValue</div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        }

        <div class="match-info" style="margin-top: 2rem;">
            <h2>Event Info</h2>
        @if (parsedTimeGmt4.HasValue)
            {
                <div class="match-info-row">
                    <span class="match-info-label">Date & Time</span>
                <span class="match-info-value">@parsedTimeGmt4.Value.ToString("dd MMMM yyyy Â· HH:mm") (GMT+4)</span>
                </div>
            }
            @if (!string.IsNullOrEmpty(venueName) && !Model.Venue.HasValue)
            {
                <div class="match-info-row">
                    <span class="match-info-label">Venue</span>
                    <span class="match-info-value">@venueName</span>
                </div>
            }
            <div class="match-info-row">
                <span class="match-info-label">Status</span>
                <span class="match-info-value">@status</span>
            </div>
        @if (homeScore.HasValue && awayScore.HasValue)
        {
            <div class="match-info-row">
                <span class="match-info-label">Live Score</span>
                <span class="match-info-value">@homeScore - @awayScore</span>
            </div>
        }
            @if (minute.HasValue && !Model.IsFinishedEvent)
            {
                <div class="match-info-row">
                    <span class="match-info-label">Minute</span>
                    <span class="match-info-value">@minute'</span>
                </div>
            }
        </div>
    </section>
}
