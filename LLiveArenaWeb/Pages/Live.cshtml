@page
@model LiveModel
@using LLiveArenaWeb.Models
@{
    ViewData["Title"] = "Live Streams";
}

@functions {
    private string GetMatchDisplayName(MatchListItem match)
    {
        if (match.Section == null || match.Section.Count < 2) return match.Ename;
        
        var homeTeam = match.Section.FirstOrDefault(s => s.Sno == 1);
        var awayTeam = match.Section.FirstOrDefault(s => s.Sno == 3);
        
        if (homeTeam != null && awayTeam != null)
        {
            return $"{homeTeam.Nat} vs {awayTeam.Nat}";
        }
        
        return match.Ename;
    }
}

<section class="hero">
    <span class="tag">Live</span>
    <h1>Live Streams</h1>
    <p>Choose a match to watch live streams instantly with smooth playback.</p>
</section>

<section class="stream-layout">
    <aside class="stream-sidebar">
        <h2>Live Matches</h2>
        @if (Model.LiveMatches.Any())
        {
            <p style="font-size: 0.85rem; color: #888; margin-bottom: 1rem;">
                @Model.LiveMatches.Count live match@(Model.LiveMatches.Count != 1 ? "es" : "") across @Model.LiveMatchesByLeague.Count league@(Model.LiveMatchesByLeague.Count != 1 ? "s" : "")
            </p>
        }
        <div class="category-list" data-stream-categories>
            @if (Model.LiveMatchesByLeague.Any())
            {
                @foreach (var leagueGroup in Model.LiveMatchesByLeague)
                {
                    var leagueId = leagueGroup.Key.Replace(" ", "-").Replace("/", "-").ToLowerInvariant();
                    <div style="margin-bottom: 1.5rem;">
                        <button class="league-toggle" type="button" data-collapse-toggle="league-@leagueId">
                            <span>@leagueGroup.Key</span>
                            <span class="league-toggle-meta">@leagueGroup.Value.Count</span>
                        </button>
                        <div class="league-collapse show" data-collapse-panel="league-@leagueId">
                            <div class="league-collapse-inner">
                            @foreach (var match in leagueGroup.Value)
                            {
                                var isSelected = Model.SelectedMatch?.Gmid == match.Gmid;
                                <button class="category-item @(isSelected ? "active" : "")"
                                        type="button"
                                        data-gmid="@match.Gmid"
                                        onclick="loadStream(@match.Gmid)">
                                    <div>
                                        <strong>@GetMatchDisplayName(match)</strong>
                                        @if (!string.IsNullOrEmpty(match.Stime))
                                        {
                                            <span style="font-size: 0.75rem; color: #888; display: block; margin-top: 0.25rem;">
                                                @if (DateTime.TryParse(match.Stime, out var startTime))
                                                {
                                                    @startTime.ToString("HH:mm")
                                                }
                                                else
                                                {
                                                    @match.Stime
                                                }
                                            </span>
                                        }
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem; flex-wrap: wrap;">
                                        @if (match.Tv)
                                        {
                                            <span class="status-pill" style="font-size: 0.7rem;">TV</span>
                                        }
                                        @if (match.Bm)
                                        {
                                            <span class="status-pill status-live" style="font-size: 0.7rem;">BM</span>
                                        }
                                        <span class="status-pill status-live" style="font-size: 0.7rem;">LIVE</span>
                                    </div>
                                </button>
                            }
                            </div>
                        </div>
                    </div>
                }
            }
            else if (Model.LiveMatches.Any())
            {
                @foreach (var match in Model.LiveMatches)
                {
                    var isSelected = Model.SelectedMatch?.Gmid == match.Gmid;
                    <button class="category-item @(isSelected ? "active" : "")" 
                            type="button" 
                            data-gmid="@match.Gmid"
                            onclick="loadStream(@match.Gmid)">
                        <div>
                            <strong>@GetMatchDisplayName(match)</strong>
                            @if (!string.IsNullOrEmpty(match.Cname))
                            {
                                <span style="font-size: 0.85rem; color: #888;">@match.Cname</span>
                            }
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.25rem;">
                            @if (match.Tv)
                            {
                                <span class="status-pill" style="font-size: 0.7rem;">TV</span>
                            }
                            @if (match.Bm)
                            {
                                <span class="status-pill status-live" style="font-size: 0.7rem;">BM</span>
                            }
                            <span class="status-pill status-live" style="font-size: 0.7rem;">LIVE</span>
                        </div>
                    </button>
                }
            }
            else
            {
                <p style="padding: 1rem; color: #888;">No live matches available</p>
            }
        </div>
    </aside>

    <div class="stream-main">
        <div class="stream-header">
            @if (Model.SelectedMatch != null)
            {
                <h2>@GetMatchDisplayName(Model.SelectedMatch)</h2>
                <p>@Model.SelectedMatch.Cname</p>
            }
            else
            {
                <h2>Live Stream</h2>
                <p>Select a match to load the stream</p>
            }
        </div>

        <div class="stream-frame">
            @if (Model.StreamResponse?.Success == true && !string.IsNullOrEmpty(Model.StreamResponse.Data?.StreamUrl))
            {
                <div class="stream-embed" data-stream-embed>
                    <iframe
                        id="streamFrame"
                        src="@Model.StreamResponse.Data.StreamUrl"
                        width="100%"
                        height="100%"
                        frameborder="0"
                        allowfullscreen
                        allow="autoplay; encrypted-media">
                    </iframe>
                </div>
            }
            else if (Model.SelectedMatch != null)
            {
                <div class="stream-loading" data-stream-loader>
                    <span class="spinner"></span>
                    <span>Loading stream...</span>
                    @if (Model.StreamResponse != null && !string.IsNullOrEmpty(Model.StreamResponse.Message))
                    {
                        <p style="margin-top: 1rem; color: #ff6b6b;">@Model.StreamResponse.Message</p>
                    }
                </div>
            }
            else
            {
                <div class="stream-loading" data-stream-loader>
                    <span>Please select a live match to view the stream</span>
                </div>
            }
        </div>
    </div>
</section>

<script>
    function loadStream(gmid) {
        window.location.href = '/Live?gmid=' + gmid;
    }
</script>
