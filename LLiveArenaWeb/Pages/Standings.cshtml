@page "/Standings"
@model LLiveArenaWeb.Pages.StandingsModel
@{
    ViewData["Title"] = "Standings";
}

<style>
    .standings-tabs {
        display: flex; 
        gap: 0.5rem; 
        margin-bottom: 1.5rem; 
        border-bottom: 2px solid var(--border);
    }
    .standings-tab {
        padding: 0.75rem 1.5rem; 
        background: transparent; 
        border: none; 
        border-bottom: 2px solid transparent; 
        color: var(--muted); 
        font-weight: 600; 
        font-size: 0.9rem; 
        cursor: pointer; 
        transition: all 0.2s ease;
        margin-bottom: -2px;
    }
    .standings-tab:hover {
        color: var(--accent);
    }
    .standings-tab.active {
        color: var(--accent); 
        border-bottom-color: var(--accent);
    }
    .standings-table {
        font-size: 0.875rem;
    }
    .standings-table th {
        padding: 0.75rem 0.5rem;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    .standings-table td {
        padding: 0.75rem 0.5rem;
    }
    .standings-table .team-cell {
        min-width: 180px;
    }
    .standings-table .stat-cell {
        text-align: center;
        min-width: 40px;
    }
    .standings-container {
        max-width: 50%;
        margin: 0 auto;
    }
    @@media (max-width: 768px) {
        .standings-container {
            max-width: 100%;
        }
    }
</style>

<section class="section">
    <div class="section-header">
        <h1>Standings</h1>
        @if (!string.IsNullOrEmpty(Model.LeagueName))
        {
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                @if (!string.IsNullOrEmpty(Model.LeagueLogo))
                {
                    <img src="@Model.LeagueLogo" alt="@Model.LeagueName logo" style="width: 32px; height: 32px; object-fit: contain;" />
                }
                <span style="font-size: 1.1rem; font-weight: 600;">@Model.LeagueName</span>
                @if (!string.IsNullOrEmpty(Model.SeasonName))
                {
                    <span style="font-size: 0.9rem; color: var(--muted);">- @Model.SeasonName</span>
                }
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(Model.Error))
    {
        <div style="padding: 1.5rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); color: var(--error);">
            <p>@Model.Error</p>
        </div>
    }
    else if (Model.Standings.Any())
    {
        @foreach (var standingTable in Model.Standings)
        {
            var tableName = Model.GetStringProperty(standingTable, "slug", "name", "type", "title") ?? "Standings";
            var rows = Model.GetArrayProperty(standingTable, "standings_rows");
            
            // Sort rows by position
            var sortedRows = rows.OrderBy(r => {
                var pos = Model.GetIntProperty(r, "position") ?? 999;
                return pos;
            }).ToList();
            
            <div style="margin-top: 2rem;">
                <h2 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">@tableName</h2>
                
                @if (sortedRows.Any())
                {
                    <div class="standings-container">
                        <!-- Tabs for Overall/Home/Away -->
                        <div class="standings-tabs">
                            <button class="standings-tab active" onclick="showStandingsTab('overall-@tableName', this)">Overall</button>
                            <button class="standings-tab" onclick="showStandingsTab('home-@tableName', this)">Home</button>
                            <button class="standings-tab" onclick="showStandingsTab('away-@tableName', this)">Away</button>
                        </div>
                        
                        <!-- Overall Table -->
                        <div id="overall-@tableName" class="standings-tab-content" style="display: block;">
                        <div style="overflow-x: auto; background: var(--surface-strong); border-radius: 12px; border: 1px solid var(--border);">
                            <table class="standings-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <th class="stat-cell">#</th>
                                        <th class="team-cell">Team</th>
                                        <th class="stat-cell">P</th>
                                        <th class="stat-cell">W</th>
                                        <th class="stat-cell">D</th>
                                        <th class="stat-cell">L</th>
                                        <th class="stat-cell">GF</th>
                                        <th class="stat-cell">GA</th>
                                        <th class="stat-cell">GD</th>
                                        <th class="stat-cell">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in sortedRows)
                                    {
                                        var position = Model.GetIntProperty(row, "position") ?? 0;
                                        var team = Model.GetObjectProperty(row, "team");
                                        var teamName = Model.GetStringProperty(team, "name_short", "name", "title") ?? "Team";
                                        var teamLogo = Model.GetStringProperty(team, "logo");
                                        var details = Model.GetObjectProperty(row, "details");
                                        var detailName = Model.GetStringProperty(details, "name");
                                        
                                        var fields = Model.GetObjectProperty(row, "fields");
                                        var played = Model.GetIntProperty(fields, "matches_total") ?? 0;
                                        var won = Model.GetIntProperty(fields, "wins_total") ?? 0;
                                        var drawn = Model.GetIntProperty(fields, "draws_total") ?? 0;
                                        var lost = Model.GetIntProperty(fields, "losses_total") ?? 0;
                                        var goalsTotal = Model.GetStringProperty(fields, "goals_total") ?? "0:0";
                                        var points = Model.GetIntProperty(fields, "points_total") ?? 0;
                                        
                                        var goalsParts = goalsTotal.Split(':');
                                        var goalsFor = 0;
                                        var goalsAgainst = 0;
                                        if (goalsParts.Length == 2)
                                        {
                                            int.TryParse(goalsParts[0].Trim(), out goalsFor);
                                            int.TryParse(goalsParts[1].Trim(), out goalsAgainst);
                                        }
                                        var goalDifference = goalsFor - goalsAgainst;
                                        
                                        var rowBgColor = "transparent";
                                        var detailColor = "var(--muted)";
                                        if (!string.IsNullOrEmpty(detailName))
                                        {
                                            if (detailName.Contains("Champions League", StringComparison.OrdinalIgnoreCase))
                                            {
                                                rowBgColor = "rgba(59, 130, 246, 0.1)";
                                                detailColor = "#3b82f6";
                                            }
                                            else if (detailName.Contains("Europa League", StringComparison.OrdinalIgnoreCase))
                                            {
                                                rowBgColor = "rgba(16, 185, 129, 0.1)";
                                                detailColor = "#10b981";
                                            }
                                            else if (detailName.Contains("Conference League", StringComparison.OrdinalIgnoreCase))
                                            {
                                                rowBgColor = "rgba(139, 92, 246, 0.1)";
                                                detailColor = "#8b5cf6";
                                            }
                                            else if (detailName.Contains("Relegation", StringComparison.OrdinalIgnoreCase))
                                            {
                                                rowBgColor = "rgba(239, 68, 68, 0.1)";
                                                detailColor = "#ef4444";
                                            }
                                        }
                                        
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s ease; background: @rowBgColor;" 
                                            onmouseover="this.style.background='rgba(255,255,255,0.1)';" 
                                            onmouseout="this.style.background='@rowBgColor';">
                                            <td class="stat-cell" style="font-weight: 700; color: var(--muted);">@position</td>
                                            <td class="team-cell">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    @if (!string.IsNullOrEmpty(teamLogo))
                                                    {
                                                        <img src="@teamLogo" alt="@teamName logo" style="width: 20px; height: 20px; object-fit: contain; flex-shrink: 0;" />
                                                    }
                                                    <div style="display: flex; flex-direction: column; gap: 0.1rem; min-width: 0;">
                                                        <span style="font-weight: 600; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@teamName</span>
                                                        @if (!string.IsNullOrEmpty(detailName))
                                                        {
                                                            <span style="font-size: 0.65rem; color: @detailColor; font-weight: 500;">@detailName</span>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="stat-cell">@played</td>
                                            <td class="stat-cell">@won</td>
                                            <td class="stat-cell">@drawn</td>
                                            <td class="stat-cell">@lost</td>
                                            <td class="stat-cell">@goalsFor</td>
                                            <td class="stat-cell">@goalsAgainst</td>
                                            <td class="stat-cell" style="font-weight: 600;">@(goalDifference > 0 ? "+" : "")@goalDifference</td>
                                            <td class="stat-cell" style="font-weight: 700; color: var(--accent);">@points</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        </div>
                        
                        <!-- Home Table -->
                        <div id="home-@tableName" class="standings-tab-content" style="display: none;">
                        <div style="overflow-x: auto; background: var(--surface-strong); border-radius: 12px; border: 1px solid var(--border);">
                            <table class="standings-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <th class="stat-cell">#</th>
                                        <th class="team-cell">Team</th>
                                        <th class="stat-cell">P</th>
                                        <th class="stat-cell">W</th>
                                        <th class="stat-cell">D</th>
                                        <th class="stat-cell">L</th>
                                        <th class="stat-cell">GF</th>
                                        <th class="stat-cell">GA</th>
                                        <th class="stat-cell">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in sortedRows.OrderBy(r => Model.GetIntProperty(r, "home_position") ?? 999))
                                    {
                                        var homePosition = Model.GetIntProperty(row, "home_position") ?? 0;
                                        var team = Model.GetObjectProperty(row, "team");
                                        var teamName = Model.GetStringProperty(team, "name_short", "name", "title") ?? "Team";
                                        var teamLogo = Model.GetStringProperty(team, "logo");
                                        
                                        var homeFields = Model.GetObjectProperty(row, "home_fields");
                                        var played = Model.GetIntProperty(homeFields, "matches_home") ?? 0;
                                        var won = Model.GetIntProperty(homeFields, "wins_home") ?? 0;
                                        var drawn = Model.GetIntProperty(homeFields, "draws_home") ?? 0;
                                        var lost = Model.GetIntProperty(homeFields, "losses_home") ?? 0;
                                        var goalsHome = Model.GetStringProperty(homeFields, "goals_home") ?? "0:0";
                                        var points = Model.GetIntProperty(homeFields, "points_home") ?? 0;
                                        
                                        var goalsParts = goalsHome.Split(':');
                                        var goalsFor = 0;
                                        var goalsAgainst = 0;
                                        if (goalsParts.Length == 2)
                                        {
                                            int.TryParse(goalsParts[0].Trim(), out goalsFor);
                                            int.TryParse(goalsParts[1].Trim(), out goalsAgainst);
                                        }
                                        
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s ease;" 
                                            onmouseover="this.style.background='rgba(255,255,255,0.1)';" 
                                            onmouseout="this.style.background='transparent';">
                                            <td class="stat-cell" style="font-weight: 700; color: var(--muted);">@homePosition</td>
                                            <td class="team-cell">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    @if (!string.IsNullOrEmpty(teamLogo))
                                                    {
                                                        <img src="@teamLogo" alt="@teamName logo" style="width: 20px; height: 20px; object-fit: contain; flex-shrink: 0;" />
                                                    }
                                                    <span style="font-weight: 600; font-size: 0.875rem;">@teamName</span>
                                                </div>
                                            </td>
                                            <td class="stat-cell">@played</td>
                                            <td class="stat-cell">@won</td>
                                            <td class="stat-cell">@drawn</td>
                                            <td class="stat-cell">@lost</td>
                                            <td class="stat-cell">@goalsFor</td>
                                            <td class="stat-cell">@goalsAgainst</td>
                                            <td class="stat-cell" style="font-weight: 700; color: var(--accent);">@points</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        </div>
                        
                        <!-- Away Table -->
                        <div id="away-@tableName" class="standings-tab-content" style="display: none;">
                        <div style="overflow-x: auto; background: var(--surface-strong); border-radius: 12px; border: 1px solid var(--border);">
                            <table class="standings-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <th class="stat-cell">#</th>
                                        <th class="team-cell">Team</th>
                                        <th class="stat-cell">P</th>
                                        <th class="stat-cell">W</th>
                                        <th class="stat-cell">D</th>
                                        <th class="stat-cell">L</th>
                                        <th class="stat-cell">GF</th>
                                        <th class="stat-cell">GA</th>
                                        <th class="stat-cell">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in sortedRows.OrderBy(r => Model.GetIntProperty(r, "away_position") ?? 999))
                                    {
                                        var awayPosition = Model.GetIntProperty(row, "away_position") ?? 0;
                                        var team = Model.GetObjectProperty(row, "team");
                                        var teamName = Model.GetStringProperty(team, "name_short", "name", "title") ?? "Team";
                                        var teamLogo = Model.GetStringProperty(team, "logo");
                                        
                                        var awayFields = Model.GetObjectProperty(row, "away_fields");
                                        var played = Model.GetIntProperty(awayFields, "matches_away") ?? 0;
                                        var won = Model.GetIntProperty(awayFields, "wins_away") ?? 0;
                                        var drawn = Model.GetIntProperty(awayFields, "draws_away") ?? 0;
                                        var lost = Model.GetIntProperty(awayFields, "losses_away") ?? 0;
                                        var goalsAway = Model.GetStringProperty(awayFields, "goals_away") ?? "0:0";
                                        var points = Model.GetIntProperty(awayFields, "points_away") ?? 0;
                                        
                                        var goalsParts = goalsAway.Split(':');
                                        var goalsFor = 0;
                                        var goalsAgainst = 0;
                                        if (goalsParts.Length == 2)
                                        {
                                            int.TryParse(goalsParts[0].Trim(), out goalsFor);
                                            int.TryParse(goalsParts[1].Trim(), out goalsAgainst);
                                        }
                                        
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s ease;" 
                                            onmouseover="this.style.background='rgba(255,255,255,0.1)';" 
                                            onmouseout="this.style.background='transparent';">
                                            <td class="stat-cell" style="font-weight: 700; color: var(--muted);">@awayPosition</td>
                                            <td class="team-cell">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    @if (!string.IsNullOrEmpty(teamLogo))
                                                    {
                                                        <img src="@teamLogo" alt="@teamName logo" style="width: 20px; height: 20px; object-fit: contain; flex-shrink: 0;" />
                                                    }
                                                    <span style="font-weight: 600; font-size: 0.875rem;">@teamName</span>
                                                </div>
                                            </td>
                                            <td class="stat-cell">@played</td>
                                            <td class="stat-cell">@won</td>
                                            <td class="stat-cell">@drawn</td>
                                            <td class="stat-cell">@lost</td>
                                            <td class="stat-cell">@goalsFor</td>
                                            <td class="stat-cell">@goalsAgainst</td>
                                            <td class="stat-cell" style="font-weight: 700; color: var(--accent);">@points</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        </div>
                    </div>
                }
                else
                {
                    <div style="padding: 2rem; text-align: center; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);">
                        <p style="color: var(--muted);">No standings data available for this table.</p>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div style="padding: 3rem; text-align: center; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); margin-top: 2rem;">
            <p style="color: var(--muted); font-size: 1.1rem;">No standings available for this season.</p>
        </div>
    }
</section>

<script>
    function showStandingsTab(tabId, button) {
        // Hide all tab contents in the same container
        const container = button.closest('.standings-tabs').parentElement;
        container.querySelectorAll('.standings-tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Remove active class from all tabs
        container.querySelectorAll('.standings-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabId).style.display = 'block';
        button.classList.add('active');
    }
</script>
