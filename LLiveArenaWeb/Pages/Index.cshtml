@page
@model IndexModel
@using LLiveArenaWeb.Models
@{
    ViewData["Title"] = "Home";
}

@functions {
    private string GetMatchDisplayName(MatchListItem match)
    {
        if (match.Section == null || match.Section.Count < 2) return match.Ename;
        
        var homeTeam = match.Section.FirstOrDefault(s => s.Sno == 1);
        var awayTeam = match.Section.FirstOrDefault(s => s.Sno == 3);
        
        if (homeTeam != null && awayTeam != null)
        {
            return $"{homeTeam.Nat} vs {awayTeam.Nat}";
        }
        
        return match.Ename;
    }
    
    private string GetMatchStatus(MatchListItem match)
    {
        if (match.Iplay)
            return "Live";
        if (match.Status == "SUSPENDED")
            return "Suspended";
        if (match.Status == "OPEN")
            return "Upcoming";
        return match.Status;
    }

    private string NormalizeCompetitionName(string? competitionName)
    {
        if (string.IsNullOrWhiteSpace(competitionName))
        {
            return "Top League";
        }

        var name = competitionName.ToUpperInvariant();
        if (name.Contains("CHAMPIONS LEAGUE"))
        {
            return "Champions League";
        }
        if (name.Contains("EUROPA") || name.Contains("EUROPE"))
        {
            return "Europa League";
        }
        if (name.Contains("CONFERENCE"))
        {
            return "Conference League";
        }
        if (name.Contains("WORLD CUP"))
        {
            return "World Cup";
        }
        if (name.Contains("EURO"))
        {
            return "Euro Cup";
        }
        if (name.Contains("COPA AMERICA"))
        {
            return "Copa America";
        }

        return competitionName;
    }
    
    private string GetStatusClass(MatchListItem match)
    {
        if (match.Iplay)
            return "status-live";
        if (match.Status == "SUSPENDED")
            return "";
        return "status-hot";
    }
    
    private DateTime? ParseStartTime(string stime)
    {
        if (DateTime.TryParse(stime, out var result))
        {
            return result;
        }
        return null;
    }
}

<section class="hero">
    <span class="tag">Live now</span>
    <h1>Live Sports Center</h1>
    <p>Watch, follow and track live sports events</p>
</section>

<section class="section">
    <div class="section-header">
        <h2>@(Model.ActiveTab == "live-events" ? "Live Events" : (Model.SelectedLeagueDisplay ?? "Top Leagues"))</h2>
        <div class="app-nav-tabs" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <a asp-page="/Index" asp-route-tab="leagues" class="nav-link @(Model.ActiveTab == "leagues" ? "active" : "")" style="text-decoration: none;">Top Leagues</a>
            <a asp-page="/Index" asp-route-tab="live-events" class="nav-link @(Model.ActiveTab == "live-events" ? "active" : "")" style="text-decoration: none;">Live Events</a>
        </div>
    </div>
    <div class="top-leagues-layout">
        <div class="top-leagues-list">
            @if (Model.ActiveTab == "live-events")
            {
                @if (Model.LiveEvents.Any())
                {
                    @foreach (var evt in Model.LiveEvents)
                    {
                        var eventId = evt.TryGetProperty("id", out var idEl) && idEl.ValueKind == System.Text.Json.JsonValueKind.Number ? idEl.GetInt32() : 0;
                        
                        // Try different possible property names for teams
                        var homeTeam = default(System.Text.Json.JsonElement);
                        if (evt.TryGetProperty("home_team", out var ht1)) homeTeam = ht1;
                        else if (evt.TryGetProperty("homeTeam", out var ht2)) homeTeam = ht2;
                        else if (evt.TryGetProperty("home", out var ht3)) homeTeam = ht3;
                        
                        var awayTeam = default(System.Text.Json.JsonElement);
                        if (evt.TryGetProperty("away_team", out var at1)) awayTeam = at1;
                        else if (evt.TryGetProperty("awayTeam", out var at2)) awayTeam = at2;
                        else if (evt.TryGetProperty("away", out var at3)) awayTeam = at3;
                        
                        var homeName = "Home";
                        if (homeTeam.ValueKind != System.Text.Json.JsonValueKind.Null && homeTeam.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                        {
                            if (homeTeam.TryGetProperty("name", out var hn) && hn.ValueKind == System.Text.Json.JsonValueKind.String) homeName = hn.GetString() ?? "Home";
                            else if (homeTeam.ValueKind == System.Text.Json.JsonValueKind.String) homeName = homeTeam.GetString() ?? "Home";
                        }
                        
                        var awayName = "Away";
                        if (awayTeam.ValueKind != System.Text.Json.JsonValueKind.Null && awayTeam.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                        {
                            if (awayTeam.TryGetProperty("name", out var an) && an.ValueKind == System.Text.Json.JsonValueKind.String) awayName = an.GetString() ?? "Away";
                            else if (awayTeam.ValueKind == System.Text.Json.JsonValueKind.String) awayName = awayTeam.GetString() ?? "Away";
                        }
                        
                        // Try different possible property names for scores
                        int? homeScore = null;
                        if (evt.TryGetProperty("home_score", out var hs1) && hs1.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hs1.GetInt32();
                        else if (evt.TryGetProperty("homeScore", out var hs2) && hs2.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hs2.GetInt32();
                        else if (homeTeam.ValueKind != System.Text.Json.JsonValueKind.Null && homeTeam.TryGetProperty("score", out var hs3) && hs3.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hs3.GetInt32();
                        
                        int? awayScore = null;
                        if (evt.TryGetProperty("away_score", out var aws1) && aws1.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = aws1.GetInt32();
                        else if (evt.TryGetProperty("awayScore", out var aws2) && aws2.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = aws2.GetInt32();
                        else if (awayTeam.ValueKind != System.Text.Json.JsonValueKind.Null && awayTeam.TryGetProperty("score", out var aws3) && aws3.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = aws3.GetInt32();
                        
                        // Try different possible property names for league
                        var league = default(System.Text.Json.JsonElement);
                        if (evt.TryGetProperty("league", out var lg1)) league = lg1;
                        else if (evt.TryGetProperty("tournament", out var lg2)) league = lg2;
                        else if (evt.TryGetProperty("competition", out var lg3)) league = lg3;
                        
                        var leagueName = "League";
                        if (league.ValueKind != System.Text.Json.JsonValueKind.Null && league.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                        {
                            if (league.TryGetProperty("name", out var ln) && ln.ValueKind == System.Text.Json.JsonValueKind.String) leagueName = ln.GetString() ?? "League";
                            else if (league.ValueKind == System.Text.Json.JsonValueKind.String) leagueName = league.GetString() ?? "League";
                        }
                        
                        var status = "Live";
                        if (evt.TryGetProperty("status", out var st) && st.ValueKind == System.Text.Json.JsonValueKind.String) status = st.GetString() ?? "Live";
                        else if (evt.TryGetProperty("state", out var st2) && st2.ValueKind == System.Text.Json.JsonValueKind.String) status = st2.GetString() ?? "Live";
                        
                        int? minute = null;
                        if (evt.TryGetProperty("minute", out var min1) && min1.ValueKind == System.Text.Json.JsonValueKind.Number) minute = min1.GetInt32();
                        else if (evt.TryGetProperty("current_minute", out var min2) && min2.ValueKind == System.Text.Json.JsonValueKind.Number) minute = min2.GetInt32();
                        else if (evt.TryGetProperty("time", out var min3) && min3.ValueKind == System.Text.Json.JsonValueKind.Number) minute = min3.GetInt32();
                        
                        <a asp-page="/EventDetails" asp-route-eventId="@eventId" class="league-card">
                            <div class="league-card-meta">
                                <span class="league-card-label">@leagueName</span>
                                <h3>@homeName vs @awayName</h3>
                                <p>
                                    @if (homeScore.HasValue && awayScore.HasValue)
                                    {
                                        <text>@homeScore - @awayScore</text>
                                        @if (minute.HasValue)
                                        {
                                            <text> 路 @minute'</text>
                                        }
                                    }
                                    else
                                    {
                                        <text>@status</text>
                                        @if (minute.HasValue)
                                        {
                                            <text> 路 @minute'</text>
                                        }
                                    }
                                </p>
                            </div>
                            <div class="league-card-status">
                                <span class="status-pill status-live">Live</span>
                                <span class="league-card-time">@status</span>
                            </div>
                        </a>
                    }
                }
                else
                {
                    <div class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">Live Events</span>
                            <h3>No live events at the moment</h3>
                            <p>Check back soon for live matches.</p>
                        </div>
                    </div>
                }
            }
            else if (Model.LeagueMatches.Any())
            {
                @foreach (var match in Model.LeagueMatches)
                {
                    var startTime = ParseStartTime(match.Stime);
                    var targetPage = match.Iplay ? "/Live" : "/Match";
                    <a asp-page="@targetPage" asp-route-gmid="@match.Gmid" class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">@NormalizeCompetitionName(match.Cname)</span>
                            <h3>@GetMatchDisplayName(match)</h3>
                            <p>
                                @if (startTime.HasValue)
                                {
                                    <text>@startTime.Value.ToString("dd MMM 路 HH:mm")</text>
                                }
                                else if (!string.IsNullOrEmpty(match.Stime))
                                {
                                    <text>@match.Stime</text>
                                }
                                else
                                {
                                    <text>Upcoming</text>
                                }
                            </p>
                        </div>
                        <div class="league-card-status">
                            <span class="status-pill @GetStatusClass(match)">@GetMatchStatus(match)</span>
                            <span class="league-card-time">@(match.Iplay ? "Live" : "Prematch")</span>
                        </div>
                    </a>
                }
            }
            else if (Model.PrematchMatches.Any())
            {
                @foreach (var match in Model.PrematchMatches.Take(2))
                {
                    var startTime = ParseStartTime(match.Stime);
                    var targetPage = match.Iplay ? "/Live" : "/Match";
                    <a asp-page="@targetPage" asp-route-gmid="@match.Gmid" class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">@NormalizeCompetitionName(match.Cname)</span>
                            <h3>@GetMatchDisplayName(match)</h3>
                            <p>
                                @if (startTime.HasValue)
                                {
                                    <text>@startTime.Value.ToString("dd MMM 路 HH:mm")</text>
                                }
                                else if (!string.IsNullOrEmpty(match.Stime))
                                {
                                    <text>@match.Stime</text>
                                }
                                else
                                {
                                    <text>Upcoming</text>
                                }
                            </p>
                        </div>
                        <div class="league-card-status">
                            <span class="status-pill @GetStatusClass(match)">@GetMatchStatus(match)</span>
                            <span class="league-card-time">Prematch</span>
                        </div>
                    </a>
                }
            }
            else
            {
                <div class="league-card">
                    <div class="league-card-meta">
                        <span class="league-card-label">Top League</span>
                        <h3>Loading league games...</h3>
                        <p>Upcoming match details will appear here.</p>
                    </div>
                </div>
                <div class="league-card">
                    <div class="league-card-meta">
                        <span class="league-card-label">Top League</span>
                        <h3>Loading league games...</h3>
                        <p>Upcoming match details will appear here.</p>
                    </div>
                </div>
            }
        </div>

        @if (Model.ActiveTab != "live-events")
        {
        <aside class="league-side">
            <h3>Leagues</h3>
            <div class="league-list">
                <a class="league-item @(Model.SelectedLeagueKey == "champions-league" ? "active" : "")" asp-page="/Index" asp-route-league="champions-league">
                    <span class="league-logo"><img src="~/images/leagues/champions-league.webp" alt="Champions League" /></span>
                    <span>Champions League</span>
                </a>
                <a class="league-item @(Model.SelectedLeagueKey == "europa-league" ? "active" : "")" asp-page="/Index" asp-route-league="europa-league">
                    <span class="league-logo"><img src="~/images/leagues/europa-league.webp" alt="Europa League" /></span>
                    <span>Europa League</span>
                </a>
                <a class="league-item @(Model.SelectedLeagueKey == "conference-league" ? "active" : "")" asp-page="/Index" asp-route-league="conference-league">
                    <span class="league-logo"><img src="~/images/leagues/conference-league.webp" alt="Conference League" /></span>
                    <span>Conference League</span>
                </a>
                <a class="league-item @(Model.SelectedLeagueKey == "world-cup" ? "active" : "")" asp-page="/Index" asp-route-league="world-cup">
                    <span class="league-logo"><img src="~/images/leagues/world-cup.webp" alt="World Cup" /></span>
                    <span>World Cup</span>
                </a>
                <a class="league-item @(Model.SelectedLeagueKey == "euro" ? "active" : "")" asp-page="/Index" asp-route-league="euro">
                    <span class="league-logo"><img src="~/images/leagues/euro-cup.webp" alt="Euro Cup" /></span>
                    <span>Euro Cup</span>
                </a>
                <a class="league-item @(Model.SelectedLeagueKey == "copa-america" ? "active" : "")" asp-page="/Index" asp-route-league="copa-america">
                    <span class="league-logo"><img src="~/images/leagues/copa-america.webp" alt="Copa America" /></span>
                    <span>Copa America</span>
                </a>
            </div>
        </aside>
        }
    </div>
</section>

<section class="section">
    <div class="section-header">
        <h2>Latest News</h2>
        <span class="section-pill">Preview</span>
    </div>
    <div class="news-grid">
        <article class="news-card">
            <span class="news-tag">Breaking</span>
            <h3>Championship schedule announced</h3>
            <p>Full fixture list drops with prime-time matchups.</p>
        </article>
        <article class="news-card">
            <span class="news-tag">Analysis</span>
            <h3>Power rankings shake up the standings</h3>
            <p>Top teams surge after a decisive weekend.</p>
        </article>
        <article class="news-card">
            <span class="news-tag">Spotlight</span>
            <h3>Rookie star breaks debut record</h3>
            <p>Early season form hints at a breakout campaign.</p>
        </article>
    </div>
</section>

<section class="home-footer">
    <div>
        <h2>Never miss a moment</h2>
        <p>Stay locked in with live scores, instant alerts, and curated highlights.</p>
    </div>
    <a class="home-footer-button" asp-area="" asp-page="/Live">Explore Live</a>
</section>
