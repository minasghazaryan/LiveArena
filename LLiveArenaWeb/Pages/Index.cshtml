@page
@model IndexModel
@using LLiveArenaWeb.Models
@{
    ViewData["Title"] = "Home";
}

@functions {
    private string GetMatchDisplayName(MatchListItem match)
    {
        if (match.Section == null || match.Section.Count < 2) return match.Ename;
        
        var homeTeam = match.Section.FirstOrDefault(s => s.Sno == 1);
        var awayTeam = match.Section.FirstOrDefault(s => s.Sno == 3);
        
        if (homeTeam != null && awayTeam != null)
        {
            return $"{homeTeam.Nat} vs {awayTeam.Nat}";
        }
        
        return match.Ename;
    }
    
    private string GetMatchStatus(MatchListItem match)
    {
        if (match.Iplay)
            return "Live";
        if (match.Status == "SUSPENDED")
            return "Suspended";
        if (match.Status == "OPEN")
            return "Upcoming";
        return match.Status;
    }

    private string NormalizeCompetitionName(string? competitionName)
    {
        if (string.IsNullOrWhiteSpace(competitionName))
        {
            return "Top League";
        }

        var name = competitionName.ToUpperInvariant();
        if (name.Contains("CHAMPIONS LEAGUE"))
        {
            return "Champions League";
        }
        if (name.Contains("EUROPA") || name.Contains("EUROPE"))
        {
            return "Europa League";
        }
        if (name.Contains("CONFERENCE"))
        {
            return "Conference League";
        }
        if (name.Contains("WORLD CUP"))
        {
            return "World Cup";
        }
        if (name.Contains("EURO"))
        {
            return "Euro Cup";
        }
        if (name.Contains("COPA AMERICA"))
        {
            return "Copa America";
        }

        return competitionName;
    }
    
    private string GetStatusClass(MatchListItem match)
    {
        if (match.Iplay)
            return "status-live";
        if (match.Status == "SUSPENDED")
            return "";
        return "status-hot";
    }
    
    private DateTime? ParseStartTime(string stime)
    {
        if (DateTime.TryParse(stime, out var result))
        {
            return result;
        }
        return null;
    }
    
    private string Slugify(string? input)
    {
        if (string.IsNullOrWhiteSpace(input)) return "team";
        var cleaned = System.Text.RegularExpressions.Regex.Replace(input.ToLowerInvariant(), @"[^a-z0-9]+", "-");
        return cleaned.Trim('-');
    }
}

<section class="hero">
    <span class="tag">Live now</span>
    <h1>Live Sports Center</h1>
    <p>Watch, follow and track live sports events</p>
</section>

<script>
    function toggleLeaguePanel(panelId) {
        var panel = document.getElementById(panelId);
        if (!panel) return;
        
        var isHidden = panel.style.display === 'none';
        panel.style.display = isHidden ? 'flex' : 'none';
        
        // Update button text
        var button = document.querySelector('[data-target="' + panelId + '"]');
        if (button) {
            button.textContent = isHidden ? '‚ñ≤' : '‚ñº';
            button.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        }
    }
    
    // Initialize all panels as expanded
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-toggle="league-panel"]').forEach(function(btn) {
            var targetId = btn.getAttribute('data-target');
            if (targetId) {
                var panel = document.getElementById(targetId);
                if (panel) {
                    panel.style.display = 'flex';
                    btn.textContent = '‚ñ≤';
                    btn.setAttribute('aria-expanded', 'true');
                }
            }
        });
    });
    
    // Load seasons for a league
    function loadSeasons(leagueId, leagueName, leagueLogo) {
        var modal = document.getElementById('seasonsModal');
        var modalContent = document.getElementById('seasonsModalContent');
        var loadingDiv = document.getElementById('seasonsLoading');
        var seasonsList = document.getElementById('seasonsList');
        var leagueTitle = document.getElementById('seasonsLeagueTitle');
        var leagueLogoImg = document.getElementById('seasonsLeagueLogo');
        
        if (!modal || !modalContent) return;
        
        // Show modal
        modal.style.display = 'flex';
        
        // Update header
        if (leagueTitle) leagueTitle.textContent = leagueName || 'Seasons';
        if (leagueLogoImg && leagueLogo) {
            leagueLogoImg.src = leagueLogo;
            leagueLogoImg.style.display = 'block';
        } else if (leagueLogoImg) {
            leagueLogoImg.style.display = 'none';
        }
        
        // Show loading, hide list
        if (loadingDiv) loadingDiv.style.display = 'block';
        if (seasonsList) {
            seasonsList.innerHTML = '';
            seasonsList.style.display = 'none';
        }
        
        // Fetch seasons
        fetch('/api/seasons/' + leagueId)
            .then(response => response.json())
            .then(data => {
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (seasonsList) {
                    seasonsList.style.display = 'grid';
                    
                    if (data.seasons && data.seasons.length > 0) {
                        seasonsList.innerHTML = data.seasons.map(function(season) {
                            var yearText = '';
                            if (season.yearStart && season.yearEnd) {
                                yearText = season.yearStart + ' - ' + season.yearEnd;
                            }
                            
                            return '<a href="/Standings?seasonId=' + season.id + '&leagueId=' + leagueId + '" class="challenge-card" style="display: block; background: var(--surface-strong); border-radius: 12px; border: 1px solid var(--border); padding: 1.5rem; transition: all 0.2s ease; cursor: pointer; text-decoration: none; color: inherit;">' +
                                '<div style="display: flex; flex-direction: column; gap: 0.75rem;">' +
                                '<h3 style="font-size: 1.1rem; font-weight: 700; margin: 0;">' + (season.name || 'Season') + '</h3>' +
                                (season.slug ? '<div style="font-size: 0.85rem; color: var(--muted);">' + season.slug + '</div>' : '') +
                                (yearText ? '<div style="display: flex; gap: 1rem; margin-top: 0.5rem;">' +
                                    '<span style="font-size: 0.75rem; color: var(--muted); padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">' + yearText + '</span>' +
                                '</div>' : '') +
                                '</div>' +
                                '</a>';
                        }).join('');
                    } else {
                        seasonsList.innerHTML = '<div style="grid-column: 1 / -1; padding: 3rem; text-align: center; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);"><p style="color: var(--muted); font-size: 1.1rem;">No current seasons available for this league.</p></div>';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading seasons:', error);
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (seasonsList) {
                    seasonsList.style.display = 'block';
                    seasonsList.innerHTML = '<div style="padding: 3rem; text-align: center; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border);"><p style="color: var(--error); font-size: 1.1rem;">Failed to load seasons. Please try again.</p></div>';
                }
            });
    }
    
    // Close seasons modal
    function closeSeasonsModal() {
        var modal = document.getElementById('seasonsModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        var modal = document.getElementById('seasonsModal');
        if (event.target == modal) {
            closeSeasonsModal();
        }
    }
</script>

@if (Model.TopMatches.Any())
{
    <section class="top-matches-section" style="margin: 2rem 0; max-width: 1140px; margin-left: auto; margin-right: auto;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
            <span style="font-size: 1.25rem;">üî•</span>
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Top Matches</h2>
        </div>
        <div class="top-match" style="display: flex; width: 100%; height: 250px; background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            @for (int i = 0; i < Math.Min(2, Model.TopMatches.Count); i++)
            {
                var match = Model.TopMatches[i];
                var homeTeam = match.Section?.FirstOrDefault(s => s.Sno == 1);
                var awayTeam = match.Section?.FirstOrDefault(s => s.Sno == 3);
                var isLive = match.Iplay;
                var startTime = ParseStartTime(match.Stime);
                
                <div style="flex: 1; display: flex; flex-direction: column; padding: 1.5rem; position: relative; @(i == 0 ? "border-right: 2px dotted rgba(147, 51, 234, 0.3);" : "")">
                    <div style="text-align: center; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        @{
                            var leagueName = NormalizeCompetitionName(match.Cname);
                            string? leagueLogo = null;
                            
                            // Try exact match first
                            if (Model.LeagueLogos.ContainsKey(leagueName))
                                leagueLogo = Model.LeagueLogos[leagueName];
                            else if (!string.IsNullOrEmpty(match.Cname) && Model.LeagueLogos.ContainsKey(match.Cname))
                                leagueLogo = Model.LeagueLogos[match.Cname];
                            else
                            {
                                // Try partial match
                                var matchLeague = Model.LeagueLogos.Keys.FirstOrDefault(k => 
                                    leagueName.Contains(k, StringComparison.OrdinalIgnoreCase) ||
                                    k.Contains(leagueName, StringComparison.OrdinalIgnoreCase) ||
                                    (!string.IsNullOrEmpty(match.Cname) && (match.Cname.Contains(k, StringComparison.OrdinalIgnoreCase) || k.Contains(match.Cname, StringComparison.OrdinalIgnoreCase))));
                                if (matchLeague != null)
                                    leagueLogo = Model.LeagueLogos[matchLeague];
                            }
                        }
                        @if (!string.IsNullOrEmpty(leagueLogo))
                        {
                            <img src="@leagueLogo" alt="@leagueName logo" style="width: 24px; height: 24px; object-fit: contain;" />
                        }
                        <div style="font-size: 0.85rem; font-weight: 600; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 0.5px;">@leagueName</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; flex: 1;">
                        <div style="text-align: center; flex: 1;">
                            @{
                                var homeTeamName = homeTeam?.Nat ?? "Home";
                                var homeTeamLogo = Model.TeamLogos.ContainsKey(homeTeamName) ? Model.TeamLogos[homeTeamName] : null;
                            }
                            <div style="width: 80px; height: 80px; margin: 0 auto 0.5rem; border-radius: 50%; background: var(--surface-strong); display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.1);">
                                @if (!string.IsNullOrEmpty(homeTeamLogo))
                                {
                                    <img src="@homeTeamLogo" alt="@homeTeamName logo" style="width: 60px; height: 60px; object-fit: contain;" />
                                }
                                else
                                {
                                    <img src="~/images/teams/@(Slugify(homeTeamName)).svg" alt="@homeTeamName" style="width: 60px; height: 60px; object-fit: contain;" data-fallback-initials="@(homeTeamName.Length > 0 ? homeTeamName.Substring(0, Math.Min(2, homeTeamName.Length)).ToUpper() : "H")" />
                                }
                            </div>
                            <div style="font-size: 0.9rem; font-weight: 600; color: #fff;">@homeTeamName</div>
                        </div>
                        
                        <div style="text-align: center; flex: 0 0 auto; padding: 0 1rem;">
                            @if (isLive)
                            {
                                <div style="background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">LIVE</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #fff; margin-top: 0.25rem;">
                                    @{
                                        var homeScore = match.Section?.FirstOrDefault(s => s.Sno == 1)?.Gscode ?? 0;
                                        var awayScore = match.Section?.FirstOrDefault(s => s.Sno == 3)?.Gscode ?? 0;
                                    }
                                    @homeScore:@awayScore
                                </div>
                            }
                            else if (startTime.HasValue)
                            {
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">@startTime.Value.ToString("dd MMMM", System.Globalization.CultureInfo.InvariantCulture)</div>
                                <div style="font-size: 1rem; font-weight: 600; color: #fff;">@startTime.Value.ToString("HH:mm")</div>
                            }
                            else
                            {
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8);">@GetMatchStatus(match)</div>
                            }
                        </div>
                        
                        <div style="text-align: center; flex: 1;">
                            @{
                                var awayTeamName = awayTeam?.Nat ?? "Away";
                                var awayTeamLogo = Model.TeamLogos.ContainsKey(awayTeamName) ? Model.TeamLogos[awayTeamName] : null;
                            }
                            <div style="width: 80px; height: 80px; margin: 0 auto 0.5rem; border-radius: 50%; background: var(--surface-strong); display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.1);">
                                @if (!string.IsNullOrEmpty(awayTeamLogo))
                                {
                                    <img src="@awayTeamLogo" alt="@awayTeamName logo" style="width: 60px; height: 60px; object-fit: contain;" />
                                }
                                else
                                {
                                    <img src="~/images/teams/@(Slugify(awayTeamName)).svg" alt="@awayTeamName" style="width: 60px; height: 60px; object-fit: contain;" data-fallback-initials="@(awayTeamName.Length > 0 ? awayTeamName.Substring(0, Math.Min(2, awayTeamName.Length)).ToUpper() : "A")" />
                                }
                            </div>
                            <div style="font-size: 0.9rem; font-weight: 600; color: #fff;">@awayTeamName</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; text-align: center;">
                        <a asp-page="/Match" asp-route-gmid="@match.Gmid" style="display: inline-block; padding: 0.5rem 1.5rem; background: rgba(255,255,255,0.1); color: #fff; text-decoration: none; border-radius: 6px; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.2);" 
                           onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)';" 
                           onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='';">
                            @(isLive ? "Watch Live" : "View Details")
                        </a>
                    </div>
                </div>
            }
        </div>
    </section>
}

<section class="section">
    <div class="section-header">
        <h2>@(Model.ActiveTab == "live-events" ? "Live Events" : (Model.SelectedLeagueDisplay ?? "Top Games"))</h2>
        <div class="app-nav-tabs" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <a asp-page="/Index" asp-route-tab="leagues" class="nav-link @(Model.ActiveTab == "leagues" ? "active" : "")" style="text-decoration: none;">Top Games</a>
            <a asp-page="/Index" asp-route-tab="live-events" class="nav-link @(Model.ActiveTab == "live-events" ? "active" : "")" style="text-decoration: none;">Live Events</a>
        </div>
    </div>
    @if (Model.ActiveTab == "live-events")
    {
        <div style="display: grid; grid-template-columns: 1fr minmax(0, 800px) minmax(0, 300px); gap: 1.5rem; max-width: 1400px; margin: 0 auto;">
            <div></div>
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                @if (Model.LiveEvents.Any())
                {
                    // Group events by league ID
                    var eventsByLeague = new Dictionary<int, List<System.Text.Json.JsonElement>>();
                    foreach (var evt in Model.LiveEvents)
                    {
                        // Extract league ID
                        var league = default(System.Text.Json.JsonElement);
                        if (evt.TryGetProperty("league", out var lg1)) league = lg1;
                        else if (evt.TryGetProperty("tournament", out var lg2)) league = lg2;
                        else if (evt.TryGetProperty("competition", out var lg3)) league = lg3;
                        
                        int? evtLeagueId = null;
                        if (league.ValueKind != System.Text.Json.JsonValueKind.Null && league.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                        {
                            if (league.TryGetProperty("id", out var lid) && lid.ValueKind == System.Text.Json.JsonValueKind.Number) evtLeagueId = lid.GetInt32();
                            else if (league.TryGetProperty("league_id", out var lid2) && lid2.ValueKind == System.Text.Json.JsonValueKind.Number) evtLeagueId = lid2.GetInt32();
                            else if (league.TryGetProperty("tournament_id", out var tid) && tid.ValueKind == System.Text.Json.JsonValueKind.Number) evtLeagueId = tid.GetInt32();
                        }
                        if (!evtLeagueId.HasValue)
                        {
                            if (evt.TryGetProperty("league_id", out var evtLid) && evtLid.ValueKind == System.Text.Json.JsonValueKind.Number) evtLeagueId = evtLid.GetInt32();
                            else if (evt.TryGetProperty("tournament_id", out var evtTid) && evtTid.ValueKind == System.Text.Json.JsonValueKind.Number) evtLeagueId = evtTid.GetInt32();
                        }
                        
                        var key = evtLeagueId ?? 0;
                        if (!eventsByLeague.ContainsKey(key))
                            eventsByLeague[key] = new List<System.Text.Json.JsonElement>();
                        eventsByLeague[key].Add(evt);
                    }
                    
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    @foreach (var leagueGroup in eventsByLeague.OrderBy(kvp => kvp.Key))
                    {
                        var leagueId = leagueGroup.Key;
                        var leagueEvents = leagueGroup.Value;
                        
                        // Get league name and logo
                        var leagueName = "League";
                        string? leagueLogo = null;
                        
                        if (leagueId > 0 && Model.LeagueNamesById.TryGetValue(leagueId, out var mappedLeagueName))
                        {
                            leagueName = mappedLeagueName;
                        }
                        if (leagueId > 0 && Model.LeagueLogosById.TryGetValue(leagueId, out var mappedLeagueLogo))
                        {
                            leagueLogo = mappedLeagueLogo;
                        }
                        if (string.IsNullOrEmpty(leagueLogo) && Model.LeagueLogos.ContainsKey(leagueName))
                        {
                            leagueLogo = Model.LeagueLogos[leagueName];
                        }
                        
                        var leaguePanelId = $"league-panel-{leagueId}";
                        
                        @* League header *@
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--surface-strong); border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: background 0.2s;" 
                                 onclick="toggleLeaguePanel('@leaguePanelId')" 
                                 onmouseover="this.style.background='var(--surface)'" 
                                 onmouseout="this.style.background='var(--surface-strong)'">
                                <button type="button" data-toggle="league-panel" data-target="@leaguePanelId" aria-expanded="true" onclick="event.stopPropagation(); toggleLeaguePanel('@leaguePanelId')" style="background: transparent; border: none; font-size: 0.85rem; color: var(--muted); cursor: pointer; padding: 0; flex-shrink: 0;">
                                    ‚ñ≤
                                </button>
                                @if (!string.IsNullOrEmpty(leagueLogo))
                                {
                                    <img src="@leagueLogo" alt="@leagueName logo" style="width: 24px; height: 24px; object-fit: contain;" />
                                }
                                <h3 style="margin: 0; font-size: 0.9rem; font-weight: 700; color: var(--text); text-transform: uppercase; flex: 1;">@leagueName</h3>
                                <span style="font-size: 0.75rem; color: var(--muted);">@leagueEvents.Count match@(leagueEvents.Count != 1 ? "es" : "")</span>
                            </div>
                        </div>
                        
                        // Matches for this league
                        <div id="@leaguePanelId" style="display: flex; flex-direction: column; gap: 1rem;">
                        @foreach (var evt in leagueEvents)
                        {
                            var eventId = evt.TryGetProperty("id", out var idEl) && idEl.ValueKind == System.Text.Json.JsonValueKind.Number ? idEl.GetInt32() : 0;
                                
                                // Try different possible property names for teams
                                var homeTeam = default(System.Text.Json.JsonElement);
                                if (evt.TryGetProperty("home_team", out var ht1)) homeTeam = ht1;
                                else if (evt.TryGetProperty("homeTeam", out var ht2)) homeTeam = ht2;
                                else if (evt.TryGetProperty("home", out var ht3)) homeTeam = ht3;
                                
                                var awayTeam = default(System.Text.Json.JsonElement);
                                if (evt.TryGetProperty("away_team", out var at1)) awayTeam = at1;
                                else if (evt.TryGetProperty("awayTeam", out var at2)) awayTeam = at2;
                                else if (evt.TryGetProperty("away", out var at3)) awayTeam = at3;
                                
                                var homeName = "Home";
                                if (homeTeam.ValueKind != System.Text.Json.JsonValueKind.Null && homeTeam.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                                {
                                    if (homeTeam.TryGetProperty("name", out var hn) && hn.ValueKind == System.Text.Json.JsonValueKind.String) homeName = hn.GetString() ?? "Home";
                                    else if (homeTeam.ValueKind == System.Text.Json.JsonValueKind.String) homeName = homeTeam.GetString() ?? "Home";
                                }
                                
                                var awayName = "Away";
                                if (awayTeam.ValueKind != System.Text.Json.JsonValueKind.Null && awayTeam.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                                {
                                    if (awayTeam.TryGetProperty("name", out var an) && an.ValueKind == System.Text.Json.JsonValueKind.String) awayName = an.GetString() ?? "Away";
                                    else if (awayTeam.ValueKind == System.Text.Json.JsonValueKind.String) awayName = awayTeam.GetString() ?? "Away";
                                }
                                
                                // Try different possible property names for scores
                                int? homeScore = null;
                                if (evt.TryGetProperty("home_score", out var hs1) && hs1.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hs1.GetInt32();
                                else if (evt.TryGetProperty("homeScore", out var hs2) && hs2.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hs2.GetInt32();
                                else if (homeTeam.ValueKind != System.Text.Json.JsonValueKind.Null && homeTeam.TryGetProperty("score", out var hs3) && hs3.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hs3.GetInt32();
                                
                                // Handle nested score objects like { home_score: { display: 1 }, away_score: { display: 3 } }
                                if (!homeScore.HasValue && evt.TryGetProperty("home_score", out var homeScoreObj) && homeScoreObj.ValueKind == System.Text.Json.JsonValueKind.Object)
                                {
                                    if (homeScoreObj.TryGetProperty("display", out var hsDisplay) && hsDisplay.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hsDisplay.GetInt32();
                                    else if (homeScoreObj.TryGetProperty("current", out var hsCurrent) && hsCurrent.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hsCurrent.GetInt32();
                                    else if (homeScoreObj.TryGetProperty("normal_time", out var hsNormal) && hsNormal.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hsNormal.GetInt32();
                                    else if (homeScoreObj.TryGetProperty("total", out var hsTotal) && hsTotal.ValueKind == System.Text.Json.JsonValueKind.Number) homeScore = hsTotal.GetInt32();
                                }
                                
                                int? awayScore = null;
                                if (evt.TryGetProperty("away_score", out var aws1) && aws1.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = aws1.GetInt32();
                                else if (evt.TryGetProperty("awayScore", out var aws2) && aws2.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = aws2.GetInt32();
                                else if (awayTeam.ValueKind != System.Text.Json.JsonValueKind.Null && awayTeam.TryGetProperty("score", out var aws3) && aws3.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = aws3.GetInt32();
                                
                                // Handle nested score objects for away team
                                if (!awayScore.HasValue && evt.TryGetProperty("away_score", out var awayScoreObj) && awayScoreObj.ValueKind == System.Text.Json.JsonValueKind.Object)
                                {
                                    if (awayScoreObj.TryGetProperty("display", out var asDisplay) && asDisplay.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = asDisplay.GetInt32();
                                    else if (awayScoreObj.TryGetProperty("current", out var asCurrent) && asCurrent.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = asCurrent.GetInt32();
                                    else if (awayScoreObj.TryGetProperty("normal_time", out var asNormal) && asNormal.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = asNormal.GetInt32();
                                    else if (awayScoreObj.TryGetProperty("total", out var asTotal) && asTotal.ValueKind == System.Text.Json.JsonValueKind.Number) awayScore = asTotal.GetInt32();
                                }
                                
                                // Try score object that contains both home and away
                                if ((!homeScore.HasValue || !awayScore.HasValue) && evt.TryGetProperty("score", out var scoreObj) && scoreObj.ValueKind == System.Text.Json.JsonValueKind.Object)
                                {
                                    if (!homeScore.HasValue)
                                    {
                                        if (scoreObj.TryGetProperty("home", out var scoreHome) && scoreHome.ValueKind == System.Text.Json.JsonValueKind.Number)
                                            homeScore = scoreHome.GetInt32();
                                        else if (scoreObj.TryGetProperty("home_score", out var scoreHomeScore) && scoreHomeScore.ValueKind == System.Text.Json.JsonValueKind.Number)
                                            homeScore = scoreHomeScore.GetInt32();
                                        else if (scoreObj.TryGetProperty("homeScore", out var scoreHomeScore2) && scoreHomeScore2.ValueKind == System.Text.Json.JsonValueKind.Number)
                                            homeScore = scoreHomeScore2.GetInt32();
                                    }
                                    if (!awayScore.HasValue)
                                    {
                                        if (scoreObj.TryGetProperty("away", out var scoreAway) && scoreAway.ValueKind == System.Text.Json.JsonValueKind.Number)
                                            awayScore = scoreAway.GetInt32();
                                        else if (scoreObj.TryGetProperty("away_score", out var scoreAwayScore) && scoreAwayScore.ValueKind == System.Text.Json.JsonValueKind.Number)
                                            awayScore = scoreAwayScore.GetInt32();
                                        else if (scoreObj.TryGetProperty("awayScore", out var scoreAwayScore2) && scoreAwayScore2.ValueKind == System.Text.Json.JsonValueKind.Number)
                                            awayScore = scoreAwayScore2.GetInt32();
                                    }
                                }
                                
                                // Try string score fallbacks like "3-2" or "3:2"
                                if (!homeScore.HasValue || !awayScore.HasValue)
                                {
                                    string? scoreText = null;
                                    if (evt.TryGetProperty("score", out var scoreEl) && scoreEl.ValueKind == System.Text.Json.JsonValueKind.String)
                                        scoreText = scoreEl.GetString();
                                    else if (evt.TryGetProperty("result", out var resultEl) && resultEl.ValueKind == System.Text.Json.JsonValueKind.String)
                                        scoreText = resultEl.GetString();
                                    else if (evt.TryGetProperty("final_score", out var finalEl) && finalEl.ValueKind == System.Text.Json.JsonValueKind.String)
                                        scoreText = finalEl.GetString();
                                    else if (evt.TryGetProperty("ft_score", out var ftEl) && ftEl.ValueKind == System.Text.Json.JsonValueKind.String)
                                        scoreText = ftEl.GetString();

                                    if (!string.IsNullOrWhiteSpace(scoreText))
                                    {
                                        var parts = scoreText.Split(new[] { '-', ':' }, StringSplitOptions.RemoveEmptyEntries);
                                        if (parts.Length >= 2 &&
                                            int.TryParse(parts[0].Trim(), out var hsParsed) &&
                                            int.TryParse(parts[1].Trim(), out var asParsed))
                                        {
                                            homeScore ??= hsParsed;
                                            awayScore ??= asParsed;
                                        }
                                    }
                                }
                                
                                // Get team logos
                                string? homeTeamLogo = null;
                                if (homeTeam.ValueKind != System.Text.Json.JsonValueKind.Null && homeTeam.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                                {
                                    if (homeTeam.TryGetProperty("logo", out var htLogo) && htLogo.ValueKind == System.Text.Json.JsonValueKind.String)
                                        homeTeamLogo = htLogo.GetString();
                                    else if (homeTeam.TryGetProperty("image", out var htImg) && htImg.ValueKind == System.Text.Json.JsonValueKind.String)
                                        homeTeamLogo = htImg.GetString();
                                    else if (homeTeam.TryGetProperty("logo_url", out var htLogoUrl) && htLogoUrl.ValueKind == System.Text.Json.JsonValueKind.String)
                                        homeTeamLogo = htLogoUrl.GetString();
                                }
                                // Fallback to TeamLogos dictionary
                                if (string.IsNullOrEmpty(homeTeamLogo) && Model.TeamLogos.ContainsKey(homeName))
                                    homeTeamLogo = Model.TeamLogos[homeName];
                                
                                string? awayTeamLogo = null;
                                if (awayTeam.ValueKind != System.Text.Json.JsonValueKind.Null && awayTeam.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                                {
                                    if (awayTeam.TryGetProperty("logo", out var atLogo) && atLogo.ValueKind == System.Text.Json.JsonValueKind.String)
                                        awayTeamLogo = atLogo.GetString();
                                    else if (awayTeam.TryGetProperty("image", out var atImg) && atImg.ValueKind == System.Text.Json.JsonValueKind.String)
                                        awayTeamLogo = atImg.GetString();
                                    else if (awayTeam.TryGetProperty("logo_url", out var atLogoUrl) && atLogoUrl.ValueKind == System.Text.Json.JsonValueKind.String)
                                        awayTeamLogo = atLogoUrl.GetString();
                                }
                                // Fallback to TeamLogos dictionary
                                if (string.IsNullOrEmpty(awayTeamLogo) && Model.TeamLogos.ContainsKey(awayName))
                                    awayTeamLogo = Model.TeamLogos[awayName];
                                
                                var status = "Live";
                                if (evt.TryGetProperty("status", out var st) && st.ValueKind == System.Text.Json.JsonValueKind.String) status = st.GetString() ?? "Live";
                                else if (evt.TryGetProperty("state", out var st2) && st2.ValueKind == System.Text.Json.JsonValueKind.String) status = st2.GetString() ?? "Live";
                                
                                // Remove "inprogress" status
                                if (status.Equals("inprogress", StringComparison.OrdinalIgnoreCase))
                                    status = "Live";
                                
                                int? minute = null;
                                if (evt.TryGetProperty("minute", out var min1) && min1.ValueKind == System.Text.Json.JsonValueKind.Number) minute = min1.GetInt32();
                                else if (evt.TryGetProperty("current_minute", out var min2) && min2.ValueKind == System.Text.Json.JsonValueKind.Number) minute = min2.GetInt32();
                                else if (evt.TryGetProperty("time", out var min3) && min3.ValueKind == System.Text.Json.JsonValueKind.Number) minute = min3.GetInt32();
                                
                                // Extract start time
                                string? startTimeStr = null;
                                if (evt.TryGetProperty("start_at", out var startAt) && startAt.ValueKind == System.Text.Json.JsonValueKind.String)
                                    startTimeStr = startAt.GetString();
                                else if (evt.TryGetProperty("start_time", out var startTimeProp) && startTimeProp.ValueKind == System.Text.Json.JsonValueKind.String)
                                    startTimeStr = startTimeProp.GetString();
                                else if (evt.TryGetProperty("start_date", out var startDate) && startDate.ValueKind == System.Text.Json.JsonValueKind.String)
                                    startTimeStr = startDate.GetString();
                                else if (evt.TryGetProperty("scheduled_at", out var scheduledAt) && scheduledAt.ValueKind == System.Text.Json.JsonValueKind.String)
                                    startTimeStr = scheduledAt.GetString();
                                
                                DateTime? startTime = null;
                                string? startTimeDisplay = null;
                                if (!string.IsNullOrEmpty(startTimeStr) && DateTime.TryParse(startTimeStr, out var parsedStart))
                                {
                                    // Convert to GMT+4 (add 4 hours to UTC)
                                    DateTime utcTime;
                                    if (parsedStart.Kind == DateTimeKind.Unspecified)
                                    {
                                        // Assume it's UTC if unspecified
                                        utcTime = DateTime.SpecifyKind(parsedStart, DateTimeKind.Utc);
                                    }
                                    else if (parsedStart.Kind == DateTimeKind.Local)
                                    {
                                        utcTime = parsedStart.ToUniversalTime();
                                    }
                                    else
                                    {
                                        utcTime = parsedStart;
                                    }
                                    
                                    // Add 4 hours for GMT+4
                                    var gmt4Time = utcTime.AddHours(4);
                                    startTime = gmt4Time;
                                    startTimeDisplay = gmt4Time.ToString("HH:mm");
                                }
                                
                                // Extract venue/stadium
                                string? venueName = null;
                                System.Text.Json.JsonElement venue = default;
                                if (evt.TryGetProperty("venue", out var v1)) venue = v1;
                                else if (evt.TryGetProperty("stadium", out var v2)) venue = v2;
                                else if (evt.TryGetProperty("location", out var v3)) venue = v3;
                                
                                if (venue.ValueKind != System.Text.Json.JsonValueKind.Null && venue.ValueKind != System.Text.Json.JsonValueKind.Undefined)
                                {
                                    if (venue.TryGetProperty("name", out var vn) && vn.ValueKind == System.Text.Json.JsonValueKind.String)
                                        venueName = vn.GetString();
                                    else if (venue.ValueKind == System.Text.Json.JsonValueKind.String)
                                        venueName = venue.GetString();
                                }
                            
                            <a asp-page="/EventDetails" asp-route-eventId="@eventId" class="league-card">
                            <div class="league-card-meta">
                                <div style="display: grid; grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr); align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; min-width: 0;">
                                        @if (!string.IsNullOrEmpty(homeTeamLogo))
                                        {
                                            <img src="@homeTeamLogo" alt="@homeName logo" style="width: 48px; height: 48px; object-fit: contain; flex-shrink: 0;" />
                                        }
                                        else
                                        {
                                            <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--surface-strong); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; color: var(--muted); flex-shrink: 0;">
                                                @(homeName.Length > 0 ? homeName.Substring(0, Math.Min(2, homeName.Length)).ToUpper() : "H")
                                            </div>
                                        }
                                        <span style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@homeName</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.4rem; flex-shrink: 0;">
                                        @if (homeScore.HasValue && awayScore.HasValue)
                                        {
                                            <span style="font-weight: 700; font-size: 1.25rem;">@homeScore - @awayScore</span>
                                        }
                                        else
                                        {
                                            <span style="color: var(--muted); font-size: 0.9rem;">vs</span>
                                        }
                                        @if (homeScore.HasValue && awayScore.HasValue || status.Equals("live", StringComparison.OrdinalIgnoreCase) || status.Equals("inprogress", StringComparison.OrdinalIgnoreCase))
                                        {
                                            var liveText = "LIVE";
                                            if (homeScore.HasValue && awayScore.HasValue)
                                            {
                                                liveText = $"LIVE {homeScore} - {awayScore}";
                                            }
                                            <span class="status-pill status-live" style="font-size: 0.85rem; padding: 0.35rem 0.85rem;">@liveText</span>
                                        }
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.75rem; justify-content: flex-end; min-width: 0;">
                                        <span style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@awayName</span>
                                        @if (!string.IsNullOrEmpty(awayTeamLogo))
                                        {
                                            <img src="@awayTeamLogo" alt="@awayName logo" style="width: 48px; height: 48px; object-fit: contain; flex-shrink: 0;" />
                                        }
                                        else
                                        {
                                            <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--surface-strong); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; color: var(--muted); flex-shrink: 0;">
                                                @(awayName.Length > 0 ? awayName.Substring(0, Math.Min(2, awayName.Length)).ToUpper() : "A")
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.85rem; color: var(--muted);">
                                    @if (startTimeDisplay != null)
                                    {
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>üïê</span>
                                            <span>@startTimeDisplay (GMT+4)</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(venueName))
                                    {
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>üèüÔ∏è</span>
                                            <span>@venueName</span>
                                        </div>
                                    }
                                    @if (minute.HasValue && homeScore.HasValue && awayScore.HasValue)
                                    {
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span>‚è±Ô∏è</span>
                                            <span>@minute'</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </a>
                        }
                        </div>
                    }
                    </div>
                }
                else
                {
                    <div class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">Live Events</span>
                            <h3>No live events at the moment</h3>
                            <p>Check back soon for live matches.</p>
                        </div>
                    </div>
                }
            </div>
            
            <aside class="league-side">
                <h3>Leagues</h3>
                <div class="league-list">
                    @foreach (var league in Model.AllLeagues)
                    {
                        var leagueLogo = !string.IsNullOrWhiteSpace(league.Logo) ? league.Logo : null;
                    <a asp-page="/Seasons" asp-route-leagueId="@league.Id" class="league-item" style="display: block; text-decoration: none; color: inherit;">
                        <span class="league-logo">
                            @if (!string.IsNullOrEmpty(leagueLogo))
                            {
                                <img src="@leagueLogo" alt="@league.Name logo" />
                            }
                        </span>
                        <span>@league.Name</span>
                    </a>
                    }
                </div>
            </aside>
        </div>
    }
    else
    {
        <div class="top-leagues-layout">
            <div class="top-leagues-list">
            @if (Model.SelectedLeagueKey == null && Model.TopMatches.Any())
            {
                @foreach (var match in Model.TopMatches)
                {
                    var startTime = ParseStartTime(match.Stime);
                    var targetPage = match.Iplay ? "/Live" : "/Match";
                    <a asp-page="@targetPage" asp-route-gmid="@match.Gmid" class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">@NormalizeCompetitionName(match.Cname)</span>
                            <h3>@GetMatchDisplayName(match)</h3>
                            <p>
                                @if (startTime.HasValue)
                                {
                                    <text>@startTime.Value.ToString("dd MMM ¬∑ HH:mm")</text>
                                }
                                else if (!string.IsNullOrEmpty(match.Stime))
                                {
                                    <text>@match.Stime</text>
                                }
                                else
                                {
                                    <text>Upcoming</text>
                                }
                            </p>
                        </div>
                        <div class="league-card-status">
                            <span class="status-pill @GetStatusClass(match)">@GetMatchStatus(match)</span>
                            <span class="league-card-time">@(match.Iplay ? "Live" : "Prematch")</span>
                        </div>
                    </a>
                }
            }
            else if (Model.LeagueMatches.Any())
            {
                @foreach (var match in Model.LeagueMatches)
                {
                    var startTime = ParseStartTime(match.Stime);
                    var targetPage = match.Iplay ? "/Live" : "/Match";
                    <a asp-page="@targetPage" asp-route-gmid="@match.Gmid" class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">@NormalizeCompetitionName(match.Cname)</span>
                            <h3>@GetMatchDisplayName(match)</h3>
                            <p>
                                @if (startTime.HasValue)
                                {
                                    <text>@startTime.Value.ToString("dd MMM ¬∑ HH:mm")</text>
                                }
                                else if (!string.IsNullOrEmpty(match.Stime))
                                {
                                    <text>@match.Stime</text>
                                }
                                else
                                {
                                    <text>Upcoming</text>
                                }
                            </p>
                        </div>
                        <div class="league-card-status">
                            <span class="status-pill @GetStatusClass(match)">@GetMatchStatus(match)</span>
                            <span class="league-card-time">@(match.Iplay ? "Live" : "Prematch")</span>
                        </div>
                    </a>
                }
            }
            else if (Model.PrematchMatches.Any())
            {
                @foreach (var match in Model.PrematchMatches.Take(2))
                {
                    var startTime = ParseStartTime(match.Stime);
                    var targetPage = match.Iplay ? "/Live" : "/Match";
                    <a asp-page="@targetPage" asp-route-gmid="@match.Gmid" class="league-card">
                        <div class="league-card-meta">
                            <span class="league-card-label">@NormalizeCompetitionName(match.Cname)</span>
                            <h3>@GetMatchDisplayName(match)</h3>
                            <p>
                                @if (startTime.HasValue)
                                {
                                    <text>@startTime.Value.ToString("dd MMM ¬∑ HH:mm")</text>
                                }
                                else if (!string.IsNullOrEmpty(match.Stime))
                                {
                                    <text>@match.Stime</text>
                                }
                                else
                                {
                                    <text>Upcoming</text>
                                }
                            </p>
                        </div>
                        <div class="league-card-status">
                            <span class="status-pill @GetStatusClass(match)">@GetMatchStatus(match)</span>
                            <span class="league-card-time">Prematch</span>
                        </div>
                    </a>
                }
            }
            else
            {
                <div class="league-card">
                    <div class="league-card-meta">
                        <span class="league-card-label">Top Game</span>
                        <h3>Loading league games...</h3>
                        <p>Upcoming match details will appear here.</p>
                    </div>
                </div>
                <div class="league-card">
                    <div class="league-card-meta">
                        <span class="league-card-label">Top Game</span>
                        <h3>Loading league games...</h3>
                        <p>Upcoming match details will appear here.</p>
                    </div>
                </div>
            }
        </div>

        <aside class="league-side">
            <h3>Leagues</h3>
            <div class="league-list">
                @foreach (var league in Model.AllLeagues)
                {
                    var leagueLogo = !string.IsNullOrWhiteSpace(league.Logo) ? league.Logo : null;
                    <a asp-page="/Seasons" asp-route-leagueId="@league.Id" class="league-item" style="display: block; text-decoration: none; color: inherit;">
                        <span class="league-logo">
                            @if (!string.IsNullOrEmpty(leagueLogo))
                            {
                                <img src="@leagueLogo" alt="@league.Name logo" />
                            }
                        </span>
                        <span>@league.Name</span>
                    </a>
                }
            </div>
        </aside>
    </div>
    }
</section>

<section class="section">
    <div class="section-header">
        <h2>Latest News</h2>
        <span class="section-pill">Preview</span>
    </div>
    <div class="news-grid">
        <article class="news-card">
            <span class="news-tag">Breaking</span>
            <h3>Championship schedule announced</h3>
            <p>Full fixture list drops with prime-time matchups.</p>
        </article>
        <article class="news-card">
            <span class="news-tag">Analysis</span>
            <h3>Power rankings shake up the standings</h3>
            <p>Top teams surge after a decisive weekend.</p>
        </article>
        <article class="news-card">
            <span class="news-tag">Spotlight</span>
            <h3>Rookie star breaks debut record</h3>
            <p>Early season form hints at a breakout campaign.</p>
        </article>
    </div>
</section>

<section class="home-footer">
    <div>
        <h2>Never miss a moment</h2>
        <p>Stay locked in with live scores, instant alerts, and curated highlights.</p>
    </div>
    <a class="home-footer-button" asp-area="" asp-page="/Live">Explore Live</a>
</section>

<!-- Seasons Modal -->
<div id="seasonsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center;">
    <div id="seasonsModalContent" style="background: var(--surface); border-radius: 16px; padding: 2rem; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;">
        <button onclick="closeSeasonsModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">&times;</button>
        <div class="section-header" style="margin-bottom: 1.5rem;">
            <h1 id="seasonsLeagueTitle" style="margin: 0;">Seasons</h1>
            <div id="seasonsLeagueHeader" style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;">
                <img id="seasonsLeagueLogo" src="" alt="League logo" style="width: 32px; height: 32px; object-fit: contain; display: none;" />
            </div>
        </div>
        <div id="seasonsLoading" style="display: none; text-align: center; padding: 3rem;">
            <p style="color: var(--muted);">Loading seasons...</p>
        </div>
        <div id="seasonsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1rem;"></div>
    </div>
</div>
