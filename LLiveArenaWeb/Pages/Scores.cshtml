@page
@model ScoresModel
@using LLiveArenaWeb.Models
@{
    ViewData["Title"] = "Final Scores";
}

@functions {
    private string GetMatchTeams(MatchListItem match)
    {
        if (match.Section == null || match.Section.Count < 2) return match.Ename;
        
        var homeTeam = match.Section.FirstOrDefault(s => s.Sno == 1);
        var awayTeam = match.Section.FirstOrDefault(s => s.Sno == 3);
        
        if (homeTeam != null && awayTeam != null)
        {
            return $"{homeTeam.Nat} vs {awayTeam.Nat}";
        }
        
        return match.Ename;
    }
    
    private string GetBestOdds(MatchSection section)
    {
        if (section.Odds == null || !section.Odds.Any()) return "-";
        
        var backOdds = section.Odds.FirstOrDefault(o => o.Otype == "back" && o.OddsValue > 0);
        if (backOdds != null && backOdds.OddsValue > 0)
        {
            return backOdds.OddsValue.ToString("F2");
        }
        return "-";
    }
    
    private DateTime? ParseStartTime(string stime)
    {
        if (DateTime.TryParse(stime, out var result))
        {
            return result;
        }
        return null;
    }
}

<section class="hero">
    <span class="tag">Results</span>
    <h1>Final Scores</h1>
    <p>Completed matches categorized as finished results.</p>
</section>

<section class="section">
    <div class="section-header">
        <h2>Finished Matches</h2>
        <span class="section-pill">Final</span>
    </div>

    <div class="scores-table" data-scores-table>
        <div class="scores-row scores-header">
            <div>Match</div>
            <div>Time</div>
            <div>Score</div>
            <div>Status</div>
        </div>

        @if (Model.Matches.Any())
        {
            @foreach (var match in Model.Matches)
            {
                var homeTeam = match.Section?.FirstOrDefault(s => s.Sno == 1);
                var awayTeam = match.Section?.FirstOrDefault(s => s.Sno == 3);
                var drawTeam = match.Section?.FirstOrDefault(s => s.Sno == 2);
                var startTime = ParseStartTime(match.Stime);
                
                <div class="scores-row" data-score-row data-match-id="@match.Gmid">
                    <div class="match-cell">
                        <strong>@GetMatchTeams(match)</strong>
                        @if (!string.IsNullOrEmpty(match.Cname))
                        {
                            <span>@match.Cname</span>
                        }
                    </div>
                    <div class="time-cell" data-time-value="FT">FT</div>
                    <div class="score-cell" data-score-value="@(homeTeam != null && awayTeam != null ? $"{GetBestOdds(homeTeam)} - {GetBestOdds(awayTeam)}" : "-")">
                        @if (homeTeam != null && awayTeam != null)
                        {
                            <text>@GetBestOdds(homeTeam) - @GetBestOdds(awayTeam)</text>
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </div>
                    <div class="status-cell">
                        <span class="status-pill">Finished</span>
                        @if (match.Tv)
                        {
                            <span class="status-pill" style="margin-left: 0.5rem;">TV</span>
                        }
                        @if (match.Bm)
                        {
                            <span class="status-pill" style="margin-left: 0.5rem;">BM</span>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="scores-row" style="text-align: center; padding: 2rem; grid-column: 1 / -1;">
                <p>No matches available.</p>
            </div>
        }
    </div>
</section>
